<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#151925" />
  <title>Botiquín · Gestor de Medicamentos (PWA)</title>
  <!-- El manifest y el Service Worker se inyectan por JS para poder usar 1 solo archivo -->
  <style>
    /* ====== Diseño base con variables de tema ====== */
    :root{
      --bg: #0f1115;           /* fondo principal */
      --panel: #151925;        /* panel central */
      --sidebar: #1b2030;      /* sidebar */
      --text: #e6e8ee;         /* texto principal */
      --muted: #a8afc1;        /* texto secundario */
      --primary: #5dd5c4;      /* acento */
      --accent: #a78bfa;       /* acento secundario */
      --danger: #ef4444;       /* peligro */
      --warning: #f59e0b;      /* aviso */
      --success: #22c55e;      /* éxito */
      --border: #2a3042;       /* bordes */
      --card: #171c2a;         /* tarjeta */
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    /* Paletas adicionales */
    .theme-light{--bg:#f7f8fb;--panel:#ffffff;--sidebar:#eef1f7;--text:#12141a;--muted:#616c7f;--primary:#2563eb;--accent:#14b8a6;--danger:#dc2626;--warning:#d97706;--success:#16a34a;--border:#e6e9f2;--card:#ffffff;--shadow:0 8px 24px rgba(0,0,0,.08)}
    .theme-olive{--bg:#0c1110;--panel:#101614;--sidebar:#0e1312;--text:#e8efe9;--muted:#a0b3a7;--primary:#7cc39b;--accent:#e7b75f;--danger:#e57373;--warning:#e0a545;--success:#65c18c;--border:#1e2a25;--card:#0f1715}
    .theme-aqua{--bg:#071418;--panel:#0b1d24;--sidebar:#08161b;--text:#e3f6fb;--muted:#98c0cc;--primary:#29b6f6;--accent:#22d3ee;--danger:#ef5350;--warning:#ffd54f;--success:#26c6da;--border:#12303a;--card:#0b1f27}
    .theme-amethyst{--bg:#0f0d14;--panel:#151225;--sidebar:#120f1f;--text:#efe9fb;--muted:#b7a7e6;--primary:#8b5cf6;--accent:#06b6d4;--danger:#f43f5e;--warning:#f59e0b;--success:#22c55e;--border:#231b3f;--card:#18132c}
    .theme-solar{--bg:#002b36;--panel:#073642;--sidebar:#05303a;--text:#eee8d5;--muted:#93a1a1;--primary:#b58900;--accent:#2aa198;--danger:#dc322f;--warning:#cb4b16;--success:#859900;--border:#0b3942;--card:#083440}

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial}
    button,input,select,textarea{font:inherit;color:inherit}
    a{color:var(--primary);text-decoration:none}

    /* ====== Layout ====== */
    .app{display:grid;grid-template-columns:260px 1fr;height:100vh}
    .sidebar{background:var(--sidebar);border-right:1px solid var(--border);padding:16px 12px;overflow:auto}
    .main{display:flex;flex-direction:column;background:var(--panel)}
    .topbar{display:flex;align-items:center;gap:8px;padding:10px 14px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--panel);z-index:5}

    .logo{display:flex;align-items:center;gap:10px;font-weight:700}
    .logo svg{width:26px;height:26px}
    .logo .brand{letter-spacing:.2px}

    .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-left:auto}
    .toolbar .group{display:flex;gap:6px}

    .btn{border:1px solid var(--border);background:transparent;padding:8px 10px;border-radius:10px;cursor:pointer;transition:.15s ease;display:inline-flex;align-items:center;gap:6px}
    .btn:hover{background:color-mix(in srgb, var(--primary) 10%, transparent)}
    .btn.primary{border-color:color-mix(in srgb, var(--primary) 50%, var(--border));background:color-mix(in srgb, var(--primary) 15%, transparent)}
    .btn.danger{border-color:color-mix(in srgb, var(--danger) 50%, var(--border));background:color-mix(in srgb, var(--danger) 10%, transparent)}
    .btn:disabled{opacity:.5;pointer-events:none}

    .search{flex:1;max-width:420px;display:flex;align-items:center;gap:8px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:6px 10px}
    .search input{border:none;background:transparent;outline:none;width:100%}

    /* ====== Sidebar: carpetas ====== */
    .folders-header{display:flex;align-items:center;justify-content:space-between;margin:10px 6px 6px}
    .folder-list{display:flex;flex-direction:column;gap:6px}
    .folder{display:flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:var(--card);cursor:pointer}
    .folder.active{outline:2px solid var(--primary)}
    .folder-name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .folder-actions{display:flex;gap:4px}

    /* ====== Panel principal ====== */
    .content{flex:1;overflow:auto;padding:16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(320px, 1fr));gap:12px}

    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:8px;box-shadow:var(--shadow)}
    .card.dragging{opacity:.6}
    .card-header{display:flex;align-items:center;gap:8px}
    .title{font-weight:700;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .person{font-size:12px;color:var(--muted);border:1px solid var(--border);padding:2px 6px;border-radius:999px}
    .desc{color:var(--muted);display:-webkit-box;-webkit-line-clamp:5;-webkit-box-orient:vertical;overflow:hidden}
    .meta{display:flex;flex-wrap:wrap;gap:6px;color:var(--muted)}
    .tag{font-size:12px;border:1px dashed var(--border);padding:2px 6px;border-radius:999px}
    .row{display:flex;flex-wrap:wrap;gap:8px}
    .row select,.row button{min-height:34px}
    .row .spacer{flex:1}
    .checkbox{display:none}
    .select-mode .checkbox{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border:1px solid var(--border);border-radius:4px}
    .checkbox input{appearance:none;width:14px;height:14px;border-radius:3px;border:1px solid var(--border);display:inline-block;vertical-align:middle;background:transparent}
    .checkbox input:checked{background:var(--primary);border-color:var(--primary)}

    /* Fotos */
    .photos{display:flex;gap:6px;flex-wrap:wrap}
    .thumb{width:64px;height:64px;border:1px solid var(--border);border-radius:8px;overflow:hidden;background:#0002;display:inline-flex;align-items:center;justify-content:center}
    .thumb img{width:100%;height:100%;object-fit:cover}

    /* Table view */
    .table{width:100%;border-collapse:collapse;background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .table th,.table td{padding:10px;border-bottom:1px solid var(--border)}
    .table th{text-align:left;color:var(--muted);font-weight:600;background:color-mix(in srgb, var(--card) 70%, var(--panel))}
    .table tr:hover td{background:color-mix(in srgb, var(--primary) 8%, transparent)}

    /* Modales */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
    .modal.open{display:flex}
    .dialog{background:var(--panel);border:1px solid var(--border);border-radius:14px;min-width:320px;max-width:820px;width:100%;box-shadow:var(--shadow)}
    .dialog .hd{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border);font-weight:700}
    .dialog .bd{padding:14px;display:grid;gap:10px}
    .dialog .ft{display:flex;justify-content:flex-end;gap:8px;padding:12px 14px;border-top:1px solid var(--border)}
    .field{display:grid;gap:6px}
    .field input,.field textarea,.field select{border:1px solid var(--border);background:var(--card);padding:8px 10px;border-radius:10px;outline:none}
    .field textarea{min-height:80px;resize:vertical}

    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:var(--card)}
    .counter{font-size:12px;color:var(--muted)}

    .hint{color:var(--muted);font-size:12px}
    .drop-hint{border:1px dashed var(--border);border-radius:10px;padding:8px; text-align:center; color:var(--muted)}
  </style>
</head>
<body>
  <div class="app" id="app">
    <!-- ===== Sidebar ===== -->
    <aside class="sidebar" id="sidebar">
      <div class="logo" title="Botiquín · Salud digital">
        <!-- Logo SVG adaptable a tema: cruz + cápsula -->
        <svg viewBox="0 0 64 64" aria-hidden="true">
          <defs>
            <linearGradient id="g1" x1="0" x2="1" y1="0" y2="1">
              <stop offset="0%" stop-color="var(--primary)" />
              <stop offset="100%" stop-color="var(--accent)" />
            </linearGradient>
          </defs>
          <path d="M28 6h8a2 2 0 0 1 2 2v10h10a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H38v10a2 2 0 0 1-2 2h-8a2 2 0 0 1-2-2V30H16a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h10V8a2 2 0 0 1 2-2Z" fill="url(#g1)"/>
          <rect x="38" y="38" rx="9" ry="9" width="20" height="20" stroke="url(#g1)" fill="none" stroke-width="3"/>
        </svg>
        <span class="brand">Botiquín</span>
      </div>

      <div class="folders-header">
        <strong>Carpetas</strong>
        <div>
          <button class="btn" id="btnNewFolder" title="Nueva carpeta">＋</button>
        </div>
      </div>
      <div class="folder-list" id="folderList" aria-label="Lista de carpetas"></div>
      <div class="hint" style="margin-top:10px">Arrastra medicamentos a una carpeta para moverlos.</div>

      <hr style="border-color:var(--border);margin:14px 0"/>
      <div class="folders-header">
        <strong>Papelera</strong>
        <div class="folder-actions">
          <button class="btn" id="btnTrash">Ver</button>
          <button class="btn danger" id="btnEmptyTrash">Vaciar</button>
        </div>
      </div>
    </aside>

    <!-- ===== Main ===== -->
    <main class="main">
      <div class="topbar">
        <div class="pill" title="Selector de vista">
          <select id="viewSelect">
            <option value="cards">Vista tarjetas</option>
            <option value="table">Vista tabla</option>
          </select>
        </div>

        <div class="pill" title="Ordenación">
          <select id="sortSelect">
            <option value="name">Por nombre</option>
            <option value="nextDose">Por próxima toma</option>
            <option value="person">Por persona</option>
            <option value="updated">Más recientes</option>
          </select>
        </div>

        <div class="search" title="Buscar por nombre, posología o persona (tiempo real)">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--muted)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
          <input id="searchInput" placeholder="Buscar… (nombre, posología o persona)" />
        </div>

        <div class="toolbar">
          <div class="group">
            <button class="btn" id="btnSelectMode" title="Modo selección (mueve o elimina varios)">Seleccionar</button>
            <button class="btn danger" id="btnDeleteSelected" title="Eliminar seleccionados" disabled>Eliminar seleccionados</button>
            <span class="counter" id="selectedCount">0 seleccionados</span>
          </div>
          <div class="group">
            <button class="btn" id="btnUndo" title="Deshacer (Ctrl+Z)">↶</button>
            <button class="btn" id="btnRedo" title="Rehacer (Ctrl+Y / Ctrl+Shift+Z)">↷</button>
          </div>
          <div class="group">
            <button class="btn" id="btnNewMed" title="Nuevo medicamento">+ Medicamento</button>
            <button class="btn" id="btnImport" title="Importar JSON">Importar</button>
            <button class="btn" id="btnExport" title="Exportar JSON">Exportar</button>
          </div>
          <div class="group">
            <button class="btn" id="btnNotify" title="Activar recordatorios (notificaciones del navegador)">🔔</button>
            <button class="btn" id="btnTheme" title="Cambiar tema">🎨</button>
          </div>
        </div>
      </div>

      <div class="content">
        <div id="breadcrumb" class="hint" style="margin:0 0 10px 2px"></div>
        <div id="cardsView" class="grid" aria-live="polite"></div>
        <div id="tableView" style="display:none"></div>
      </div>
    </main>
  </div>

  <!-- ===== Modales ===== -->
  <div class="modal" id="medModal" role="dialog" aria-modal="true">
    <div class="dialog">
      <div class="hd">Editar medicamento <button class="btn" id="closeMedModal">✕</button></div>
      <div class="bd">
        <div class="field"><label>Nombre</label><input id="medName" placeholder="Ej. Amoxicilina 500 mg"/></div>
        <div class="field"><label>Descripción</label><textarea id="medDesc" placeholder="Breve descripción (síntomas, notas)"></textarea></div>
        <div class="field"><label>Frecuencia / Posología</label><input id="medDose" placeholder="Ej. Cada 8h durante 5 días"/></div>
        <div class="field"><label>Persona</label><input id="medPerson" placeholder="Ej. Laura, Bebé"/></div>
        <div class="field"><label>Carpeta</label><select id="medFolder"></select></div>
        <div class="field"><label>Etiquetas</label>
          <div class="row">
            <label class="pill"><input type="checkbox" id="tagUrgente"> Urgente</label>
            <label class="pill"><input type="checkbox" id="tagCronico"> Crónico</label>
            <label class="pill"><input type="checkbox" id="tagPrueba"> En prueba</label>
          </div>
        </div>
        <div class="field"><label>Próxima toma</label>
          <div class="row">
            <input type="datetime-local" id="medNext" />
            <span class="hint">(opcional, para recordatorios)</span>
          </div>
        </div>
        <div class="field"><label>Fotografías</label>
          <input type="file" id="medPhotos" accept="image/*" multiple />
          <div class="hint">Se redimensionan automáticamente (máx 1200px) para ahorrar espacio.</div>
          <div class="photos" id="medPhotosPreview"></div>
          <div class="drop-hint">También puedes arrastrar y soltar imágenes aquí o sobre una tarjeta para adjuntarlas.</div>
        </div>
      </div>
      <div class="ft">
        <button class="btn danger" id="btnArchive">Finalizar y archivar</button>
        <button class="btn" id="btnCancelEdit">Cancelar</button>
        <button class="btn primary" id="btnSaveMed">Guardar</button>
      </div>
    </div>
  </div>

  <div class="modal" id="folderModal" role="dialog" aria-modal="true">
    <div class="dialog">
      <div class="hd">Carpeta <button class="btn" id="closeFolderModal">✕</button></div>
      <div class="bd">
        <div class="field"><label>Nombre</label><input id="folderName" placeholder="Ej. Antibióticos"/></div>
      </div>
      <div class="ft">
        <button class="btn" id="btnCancelFolder">Cancelar</button>
        <button class="btn primary" id="btnSaveFolder">Guardar</button>
      </div>
    </div>
  </div>

  <div class="modal" id="trashModal" role="dialog" aria-modal="true">
    <div class="dialog">
      <div class="hd">Papelera <button class="btn" id="closeTrashModal">✕</button></div>
      <div class="bd" id="trashBody"></div>
      <div class="ft">
        <button class="btn danger" id="btnPurgeAll">Eliminar definitivamente</button>
        <button class="btn" id="btnCloseTrash">Cerrar</button>
      </div>
    </div>
  </div>

  <input type="file" id="fileInput" accept="application/json" style="display:none"/>

  <script>
  // ====== Utilidades ======
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const uid = (p='id') => p + '_' + Math.random().toString(36).slice(2,9);
  const confirmBox = (msg) => window.confirm(msg);

  // Crear e inyectar manifest.json e iconos (para PWA en 1 archivo)
  (function makeManifest(){
    const sizes = [192, 512];
    const icons = sizes.map(sz=>({
      src: makeIconDataURL(sz), sizes: `${sz}x${sz}`, type: 'image/png', purpose:'any maskable'
    }));
    const manifest = {
      name: 'Botiquín · Gestor de Medicamentos',
      short_name: 'Botiquín',
      description: 'Gestor y biblioteca de medicamentos con recordatorios y fotos.',
      start_url: '.',
      scope: '.',
      display: 'standalone',
      background_color: getComputedStyle(document.documentElement).getPropertyValue('--panel').trim() || '#151925',
      theme_color: getComputedStyle(document.documentElement).getPropertyValue('--panel').trim() || '#151925',
      icons
    };
    const blob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const link = document.createElement('link');
    link.rel = 'manifest';
    link.href = url; document.head.appendChild(link);

    function makeIconDataURL(size){
      const c=document.createElement('canvas'); c.width=c.height=size; const ctx=c.getContext('2d');
      // fondo
      ctx.fillStyle = '#0f1115'; ctx.fillRect(0,0,size,size);
      // cruz
      ctx.fillStyle = '#5dd5c4'; const s=size; const w=s*0.18; const l=s*0.3;
      ctx.fillRect(l, s*0.2, w, s*0.6); ctx.fillRect(s*0.2, l, s*0.6, w);
      // cápsula
      ctx.strokeStyle = '#a78bfa'; ctx.lineWidth = Math.max(2, s*0.04);
      const rx = s*0.62, ry=s*0.62, rw=s*0.26, rh=s*0.18; roundRect(ctx, rx-rw/2, ry-rh/2, rw, rh, rh/2); ctx.stroke();
      return c.toDataURL('image/png');
      function roundRect(ctx,x,y,w,h,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.arcTo(x+w,y,x+w,y+h,r);ctx.arcTo(x+w,y+h,x,y+h,r);ctx.arcTo(x,y+h,x,y,r);ctx.arcTo(x,y,x+w,y,r);ctx.closePath();}
    }
  })();

  // Registrar Service Worker (desde un Blob para mantener 1 archivo)
  (async function registerSW(){
    if(!('serviceWorker' in navigator)) return;
    try{
      const swCode = `
        const CACHE='botiquin-cache-v1';
        self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./']))) });
        self.addEventListener('activate',e=>{e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k))))) });
        self.addEventListener('fetch',event=>{
          const req = event.request;
          if(req.method!=='GET' || new URL(req.url).origin !== self.location.origin){ return; }
          event.respondWith(
            caches.match(req).then(res=> res || fetch(req).then(r=>{ const clone=r.clone(); caches.open(CACHE).then(c=>c.put(req, clone)); return r; }).catch(()=>caches.match('./')))
          );
        });
      `;
      const blob = new Blob([swCode], {type:'text/javascript'});
      const url = URL.createObjectURL(blob);
      await navigator.serviceWorker.register(url);
      console.log('SW registrado');
    }catch(err){ console.warn('No se pudo registrar el SW (sirve el archivo bajo HTTPS o localhost).', err); }
  })();

  // Aviso si se abre como file://
  if(location.protocol!=='https:' && location.hostname!=='localhost'){
    setTimeout(()=> toast('Para instalar como PWA: súbelo a HTTPS (p.ej., GitHub Pages/Netlify) o abre en localhost.'), 800);
  }

  // ====== Estado / Persistencia ======
  const STORAGE_KEY = 'botiquin.v2'; // v2 por fotos + PWA
  let state = {
    folders: [ { id:'all', name:'Todos', order:0 } ],
    meds: [],
    trash: { meds:[], folders:[] },
    view: 'cards',
    sort: 'name',
    theme: 'dark',
    activeFolder: 'all',
    selectMode: false,
    selected: new Set(),
    lastSaved: Date.now()
  };

  const history = { undo:[], redo:[], push(){ this.undo.push(JSON.stringify(state)); if(this.undo.length>50) this.undo.shift(); this.redo.length=0; },
                    canUndo(){return this.undo.length>0}, canRedo(){return this.redo.length>0},
                    doUndo(){ if(!this.canUndo()) return; this.redo.push(JSON.stringify(state)); state = JSON.parse(this.undo.pop()); state.selected=new Set(state.selected||[]); renderAll(); save(); },
                    doRedo(){ if(!this.canRedo()) return; this.undo.push(JSON.stringify(state)); state = JSON.parse(this.redo.pop()); state.selected=new Set(state.selected||[]); renderAll(); save(); } };

  function load(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){ try{ state = JSON.parse(raw); state.selected = new Set(state.selected||[]);}catch(e){} }
    applyTheme(state.theme);
  }
  function save(){ state.lastSaved = Date.now(); localStorage.setItem(STORAGE_KEY, JSON.stringify({...state, selected:[...state.selected]})); }

  // ====== Temas ======
  const THEMES = ['dark','light','olive','aqua','amethyst','solar'];
  function applyTheme(name){
    document.body.classList.remove(...THEMES.map(t=>'theme-'+t));
    if(name==='dark'){} else document.body.classList.add('theme-'+name);
    state.theme = name; save();
    const m = document.querySelector('meta[name="theme-color"]');
    if(m){ m.setAttribute('content', getComputedStyle(document.documentElement).getPropertyValue('--panel').trim()); }
  }

  // ====== Carpetas ======
  function addFolder(name){ history.push(); const id = uid('fld'); state.folders.push({id,name,order:Date.now()}); save(); renderFolders(); renderAll(); return id; }
  function updateFolder(id, name){ history.push(); const f = state.folders.find(x=>x.id===id); if(f){f.name=name; save(); renderFolders(); renderAll();} }
  function deleteFolder(id){ if(id==='all') return; if(!confirmBox('¿Eliminar carpeta y mover medicamentos a "Todos"?')) return;
    history.push(); state.trash.folders.push(state.folders.find(f=>f.id===id));
    state.folders = state.folders.filter(f=>f.id!==id);
    state.meds.forEach(m=>{ if(m.folderId===id) m.folderId='all'; }); save(); renderFolders(); renderAll(); }

  // Drag-and-drop de carpetas
  let draggingFolderId = null;
  function renderFolders(){
    const list = $('#folderList'); list.innerHTML='';
    state.folders.sort((a,b)=> (a.id==='all')? -1 : (b.id==='all')? 1 : a.order-b.order);
    state.folders.forEach(f=>{
      const el = document.createElement('div'); el.className='folder'+(f.id===state.activeFolder?' active':''); el.draggable = f.id!=='all';
      el.dataset.id=f.id;
      el.innerHTML = `
        <span class="folder-name">${f.name}</span>
        <div class="folder-actions">
          ${f.id!=='all'?'<button class="btn btnFolderRename" title="Renombrar">✎</button>':''}
          ${f.id!=='all'?'<button class="btn btnFolderDelete" title="Eliminar">🗑</button>':''}
        </div>`;
      el.addEventListener('click', (e)=>{ if(e.target.closest('.btn')) return; state.activeFolder=f.id; renderAll(); save(); });
      if(f.id!=='all'){
        el.addEventListener('dragstart',()=>{ draggingFolderId=f.id; el.style.opacity=.5; });
        el.addEventListener('dragend',()=>{ draggingFolderId=null; el.style.opacity=1; });
        el.addEventListener('dragover',(e)=>{ e.preventDefault(); el.style.outline='2px dashed var(--primary)'; });
        el.addEventListener('dragleave',()=>{ el.style.outline=''; });
        el.addEventListener('drop',()=>{ el.style.outline=''; history.push();
          const src = state.folders.find(x=>x.id===draggingFolderId); const dst = state.folders.find(x=>x.id===f.id);
          if(src&&dst&&src.id!==dst.id){ src.order=dst.order-1; save(); renderFolders(); }
        });
      }
      el.addEventListener('dragover',(e)=>{ e.preventDefault(); });
      el.addEventListener('drop',(e)=>{ const ids = (e.dataTransfer?.getData('text/med-ids')||'').split(',').filter(Boolean); if(!ids.length) return; history.push();
        ids.forEach(id=>{ const m=state.meds.find(x=>x.id===id); if(m) m.folderId=f.id; }); save(); renderAll(); });

      list.appendChild(el);
    });
  }

  // ====== Medicamentos ======
  let editingMedId = null;
  function newMed(){ editingMedId = null; openMedModal(); }
  function editMed(id){ editingMedId = id; openMedModal(id); }
  function duplicateMed(id){ const src = state.meds.find(m=>m.id===id); if(!src) return; history.push();
    const copy = {...src, id:uid('med'), name:src.name+' (copia)', created:Date.now(), updated:Date.now()}; state.meds.push(copy); save(); renderAll(); }
  function removeMed(id){ history.push(); const m = state.meds.find(x=>x.id===id); if(!m) return; state.trash.meds.push(m); state.meds = state.meds.filter(x=>x.id!==id); save(); renderAll(); }
  function removeSelected(){ if(!state.selected.size) return; if(!confirmBox(`¿Eliminar ${state.selected.size} seleccionados?`)) return; history.push();
    const ids=[...state.selected]; ids.forEach(id=>{ const m=state.meds.find(x=>x.id===id); if(m){ state.trash.meds.push(m); }});
    state.meds = state.meds.filter(m=>!state.selected.has(m.id)); state.selected.clear(); save(); renderAll(); }

  function setArchived(id,trueOrFalse=true){ history.push(); const m=state.meds.find(x=>x.id===id); if(m){ m.archived=!!trueOrFalse; m.updated=Date.now(); save(); renderAll(); } }

  function attachCardDrag(el, id){ el.draggable = true;
    el.addEventListener('dragstart', (e)=>{
      const ids = state.selectMode && state.selected.size ? [...state.selected] : [id];
      e.dataTransfer.setData('text/med-ids', ids.join(','));
      el.classList.add('dragging');
    });
    el.addEventListener('dragend', ()=>{ el.classList.remove('dragging'); });

    el.addEventListener('dragover', (e)=>{ if([...e.dataTransfer.items].some(i=>i.kind==='file')){ e.preventDefault(); el.style.outline='2px dashed var(--primary)'; } });
    el.addEventListener('dragleave', ()=>{ el.style.outline=''; });
    el.addEventListener('drop', async (e)=>{ if(![...e.dataTransfer.items].some(i=>i.kind==='file')) return; e.preventDefault(); el.style.outline='';
      const files = [...e.dataTransfer.files].filter(f=>f.type.startsWith('image/'));
      if(!files.length) return;
      history.push();
      const m = state.meds.find(x=>x.id===id); if(!m) return; m.photos = m.photos||[];
      for(const f of files){ const data = await fileToResizedDataURL(f, 1200); m.photos.push(data); }
      m.updated=Date.now(); save(); renderAll();
    });
  }

  // ====== Render ======
  function currentMeds(){ let meds = state.meds.filter(m=>!m.archived);
    if(state.activeFolder!=='all') meds = meds.filter(m=>m.folderId===state.activeFolder);
    const q = $('#searchInput').value.trim().toLowerCase();
    if(q) meds = meds.filter(m=> (m.name+" "+(m.dose||'')+" "+(m.person||'')).toLowerCase().includes(q));
    meds.sort((a,b)=>{
      switch(state.sort){
        case 'person': return (a.person||'').localeCompare(b.person||'') || a.name.localeCompare(b.name);
        case 'updated': return (b.updated||0) - (a.updated||0);
        case 'nextDose': return (a.nextDose||Infinity) - (b.nextDose||Infinity);
        case 'name': default: return a.name.localeCompare(b.name);
      }
    });
    return meds;
  }

  function renderAll(){ renderFolders(); renderBreadcrumb(); if(state.view==='cards'){ renderCards(); $('#cardsView').style.display='grid'; $('#tableView').style.display='none'; } else { renderTable(); $('#cardsView').style.display='none'; $('#tableView').style.display='block'; }
    updateSelectionUI(); updateUndoRedoUI(); populateFolderSelect(); }

  function renderBreadcrumb(){ const f = state.folders.find(x=>x.id===state.activeFolder); $('#breadcrumb').textContent = `Carpeta: ${f?f.name:'(desconocida)'} • ${currentMeds().length} elementos` }

  function renderCards(){ const wrap = $('#cardsView'); wrap.innerHTML=''; const meds = currentMeds(); meds.forEach(m=>{
      const card = document.createElement('div'); card.className = 'card' + (state.selectMode? ' select-mode':''); card.dataset.id = m.id; attachCardDrag(card, m.id);
      card.addEventListener('dblclick', ()=> editMed(m.id));
      const checked = state.selected.has(m.id);
      const photos = (m.photos||[]).slice(0,4).map(src=>`<span class="thumb"><img src="${src}" alt="foto"/></span>`).join('');
      card.innerHTML = `
        <div class="card-header">
          <label class="checkbox"><input type="checkbox" ${checked?'checked':''} data-sel="${m.id}"></label>
          <div class="title" title="${m.name}">${m.name}</div>
          <div class="person" title="Persona asignada">${m.person||'—'}</div>
        </div>
        ${photos?`<div class="photos">${photos}</div>`:''}
        <div class="desc">${(m.desc||'—')}</div>
        <div class="meta">
          <span class="tag" title="Frecuencia / Posología">${m.dose||'—'}</span>
          ${m.tags?.includes('urgente')?'<span class="tag" style="border-color:var(--danger);color:var(--danger)">Urgente</span>':''}
          ${m.tags?.includes('cronico')?'<span class="tag" style="border-color:var(--warning);color:var(--warning)">Crónico</span>':''}
          ${m.tags?.includes('prueba')?'<span class="tag" style="border-color:var(--accent);color:var(--accent)">En prueba</span>':''}
          ${m.nextDose?`<span class="tag" title="Próxima toma">⏰ ${new Date(m.nextDose).toLocaleString()}</span>`:''}
        </div>
        <div class="row">
          <select data-move="${m.id}" title="Mover a carpeta">
            ${state.folders.map(f=>`<option value="${f.id}" ${m.folderId===f.id?'selected':''}>${f.name}</option>`).join('')}
          </select>
          <span class="spacer"></span>
          <button class="btn" data-copy="${m.id}" title="Copiar información">Copiar</button>
          <button class="btn" data-dup="${m.id}" title="Duplicar">Duplicar</button>
          <button class="btn danger" data-del="${m.id}" title="Eliminar">🗑</button>
        </div>`;
      wrap.appendChild(card);
    });
  }

  function renderTable(){ const meds = currentMeds(); const tableWrap = $('#tableView');
    const rows = meds.map(m=>`<tr data-id="${m.id}">
      <td><label class="checkbox ${state.selectMode?'':'" style=\\"display:none\\"'}"><input type="checkbox" ${state.selected.has(m.id)?'checked':''} data-sel="${m.id}"></label></td>
      <td>${m.name}</td><td>${m.dose||'—'}</td><td>${m.person||'—'}</td><td>${m.desc||'—'}</td>
      <td>${m.nextDose?new Date(m.nextDose).toLocaleString():'—'}</td>
      <td><button class="btn" data-copy="${m.id}">Copiar</button> <button class="btn" data-dup="${m.id}">Duplicar</button> <button class="btn danger" data-del="${m.id}">Eliminar</button></td>
    </tr>`).join('');
    tableWrap.innerHTML = `<table class="table"><thead><tr><th></th><th>Nombre</th><th>Frecuencia</th><th>Persona</th><th>Descripción</th><th>Próxima toma</th><th>Acciones</th></tr></thead><tbody>${rows}</tbody></table>`;
    tableWrap.querySelectorAll('tr[data-id]').forEach(tr=> tr.addEventListener('dblclick', ()=> editMed(tr.dataset.id)));
  }

  function updateSelectionUI(){ document.body.classList.toggle('select-mode', state.selectMode); $('#btnDeleteSelected').disabled = state.selected.size===0; $('#selectedCount').textContent = `${state.selected.size} seleccionados`; $('#btnSelectMode').textContent = state.selectMode? 'Salir selección' : 'Seleccionar'; }
  function updateUndoRedoUI(){ $('#btnUndo').disabled = !history.canUndo(); $('#btnRedo').disabled = !history.canRedo(); }

  // ====== Eventos globales ======
  function bindEvents(){
    $('#btnTheme').addEventListener('click', ()=>{ const idx = THEMES.indexOf(state.theme); const next = THEMES[(idx+1)%THEMES.length]; applyTheme(next); });
    $('#btnNewMed').addEventListener('click', newMed);
    $('#btnNewFolder').addEventListener('click', ()=>{ openFolderModal(); });
    $('#btnDeleteSelected').addEventListener('click', removeSelected);
    $('#btnSelectMode').addEventListener('click', ()=>{ state.selectMode=!state.selectMode; if(!state.selectMode) state.selected.clear(); renderAll(); save(); });
    $('#btnUndo').addEventListener('click', ()=> history.doUndo());
    $('#btnRedo').addEventListener('click', ()=> history.doRedo());
    $('#btnExport').addEventListener('click', doExport);
    $('#btnImport').addEventListener('click', ()=> $('#fileInput').click());
    $('#fileInput').addEventListener('change', handleImport);
    $('#btnNotify').addEventListener('click', enableNotifications);
    $('#btnTrash').addEventListener('click', openTrashModal);
    $('#btnEmptyTrash').addEventListener('click', ()=>{ if(confirmBox('¿Vaciar por completo la papelera?')){ history.push(); state.trash.meds=[]; state.trash.folders=[]; save(); }});

    $('#searchInput').addEventListener('input', ()=>{ renderAll(); });
    $('#viewSelect').addEventListener('change', (e)=>{ state.view = e.target.value; save(); renderAll(); });
    $('#sortSelect').addEventListener('change', (e)=>{ state.sort = e.target.value; save(); renderAll(); });

    document.addEventListener('keydown', (e)=>{
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='z'){ e.preventDefault(); if(e.shiftKey){ history.doRedo(); } else { history.doUndo(); } }
      if((e.ctrlKey||e.metaKey) && (e.key.toLowerCase()==='y')){ e.preventDefault(); history.doRedo(); }
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='a'){ if(state.selectMode){ e.preventDefault(); currentMeds().forEach(m=> state.selected.add(m.id)); renderAll(); } }
      if(e.key==='Escape'){ if(state.selectMode){ state.selected.clear(); renderAll(); } }
    });

    document.body.addEventListener('change', (e)=>{
      const sel = e.target.getAttribute('data-sel'); if(sel){ if(e.target.checked) state.selected.add(sel); else state.selected.delete(sel); updateSelectionUI(); save(); }
      const move = e.target.getAttribute('data-move'); if(move){ history.push(); const m=state.meds.find(x=>x.id===move); if(m){ m.folderId=e.target.value; m.updated=Date.now(); save(); } }
    });
    document.body.addEventListener('click', (e)=>{
      const idCopy = e.target.getAttribute('data-copy'); if(idCopy){ copyMed(idCopy); }
      const idDup = e.target.getAttribute('data-dup'); if(idDup){ duplicateMed(idDup); }
      const idDel = e.target.getAttribute('data-del'); if(idDel){ if(confirmBox('¿Eliminar este medicamento?')) removeMed(idDel); }
      const rnBtn = e.target.closest('.btnFolderRename'); if(rnBtn){ const id = rnBtn.closest('.folder').dataset.id; openFolderModal(id); }
      const delBtn = e.target.closest('.btnFolderDelete'); if(delBtn){ const id = delBtn.closest('.folder').dataset.id; if(confirmBox('¿Eliminar carpeta?')) deleteFolder(id); }
    });

    $('#cardsView').addEventListener('dragover', e=>e.preventDefault());
    $('#cardsView').addEventListener('drop', (e)=>{ const ids=(e.dataTransfer?.getData('text/med-ids')||'').split(',').filter(Boolean); if(!ids.length) return; history.push(); ids.forEach(id=>{ const m=state.meds.find(x=>x.id===id); if(m) m.folderId=state.activeFolder; }); save(); renderAll(); });

    const modal = $('#medModal');
    modal.addEventListener('dragover', (e)=>{ if(e.target.closest('#medPhotosPreview')){ e.preventDefault(); }});
    modal.addEventListener('drop', async (e)=>{ if(!e.target.closest('#medPhotosPreview')) return; e.preventDefault(); const files=[...e.dataTransfer.files].filter(f=>f.type.startsWith('image/') ); await previewPhotos(files); });

    $('#medPhotos').addEventListener('change', async (e)=>{ const files=[...e.target.files]; await previewPhotos(files); });
  }

  // ====== Copiar al portapapeles ======
  async function copyMed(id){ const m=state.meds.find(x=>x.id===id); if(!m) return; const txt = `${m.name}\n${m.dose||''}\n${m.person||''}\n${m.desc||''}`.trim(); try{ await navigator.clipboard.writeText(txt); toast('Copiado en el portapapeles'); }catch{ alert('No se pudo copiar'); } }

  function toast(msg){ const t=document.createElement('div'); t.textContent=msg; t.style.position='fixed'; t.style.bottom='16px'; t.style.right='16px'; t.style.background='var(--card)'; t.style.border='1px solid var(--border)'; t.style.padding='10px 12px'; t.style.borderRadius='10px'; t.style.boxShadow='var(--shadow)'; t.style.zIndex=9999; document.body.appendChild(t); setTimeout(()=>t.remove(),1800); }

  // ====== Fotos ======
  let tempPhotos = [];// buffer temporal en el modal
  async function previewPhotos(files){
    for(const f of files){ if(!f.type.startsWith('image/')) continue; const data = await fileToResizedDataURL(f, 1200); tempPhotos.push(data); }
    paintPhotosPreview();
  }
  function paintPhotosPreview(existing=[]) {
    const box = $('#medPhotosPreview'); box.innerHTML='';
    [...existing, ...tempPhotos].forEach((src, idx)=>{
      const d=document.createElement('div'); d.className='thumb'; d.innerHTML=`<img src="${src}" alt="foto"/><button class="btn danger" data-delphoto="${idx}" style="position:absolute; transform:translate(38px,-30px)">✕</button>`;
      d.style.position='relative'; box.appendChild(d);
    });
    box.querySelectorAll('[data-delphoto]').forEach(btn=> btn.addEventListener('click', ()=>{ const i=+btn.getAttribute('data-delphoto'); tempPhotos.splice(i,1); paintPhotosPreview(existing); }));
  }
  async function fileToResizedDataURL(file, maxSide=1200){
    const img = await new Promise(res=>{ const r=new FileReader(); r.onload=()=>{ const i=new Image(); i.onload=()=>res(i); i.src=r.result; }; r.readAsDataURL(file); });
    const {width, height} = img; const scale = Math.min(1, maxSide/Math.max(width,height));
    const w = Math.round(width*scale), h = Math.round(height*scale);
    const c=document.createElement('canvas'); c.width=w; c.height=h; const ctx=c.getContext('2d');
    ctx.fillStyle='#fff'; ctx.fillRect(0,0,w,h); ctx.drawImage(img,0,0,w,h);
    return c.toDataURL('image/jpeg', 0.85);
  }

  // ====== Modales de medicamento ======
  function openMedModal(id){ tempPhotos=[]; const m = id ? state.meds.find(x=>x.id===id) : {name:'',desc:'',dose:'',person:'',folderId:state.activeFolder,tags:[],nextDose:null,photos:[]}; $('#medName').value=m.name||''; $('#medDesc').value=m.desc||''; $('#medDose').value=m.dose||''; $('#medPerson').value=m.person||''; $('#medNext').value = m.nextDose? new Date(m.nextDose).toISOString().slice(0,16):''; populateFolderSelect(); $('#medFolder').value= m.folderId||state.activeFolder; $('#tagUrgente').checked= m.tags?.includes('urgente'); $('#tagCronico').checked= m.tags?.includes('cronico'); $('#tagPrueba').checked= m.tags?.includes('prueba'); paintPhotosPreview(m.photos||[]); $('#medModal').classList.add('open'); }
  function closeMedModal(){ $('#medModal').classList.remove('open'); tempPhotos=[]; }
  function populateFolderSelect(){ const sel=$('#medFolder'); if(!sel) return; sel.innerHTML= state.folders.map(f=>`<option value="${f.id}">${f.name}</option>`).join(''); }

  $('#closeMedModal')?.addEventListener('click', closeMedModal);
  $('#btnCancelEdit')?.addEventListener('click', closeMedModal);
  $('#btnSaveMed')?.addEventListener('click', ()=>{
    const data = {
      name: $('#medName').value.trim(),
      desc: $('#medDesc').value.trim(),
      dose: $('#medDose').value.trim(),
      person: $('#medPerson').value.trim(),
      folderId: $('#medFolder').value,
      tags: [ $('#tagUrgente').checked && 'urgente', $('#tagCronico').checked && 'cronico', $('#tagPrueba').checked && 'prueba' ].filter(Boolean),
      nextDose: $('#medNext').value ? new Date($('#medNext').value).getTime() : null,
    };
    if(!data.name){ alert('Pon un nombre de medicamento'); return; }
    history.push();
    if(editingMedId){ const m = state.meds.find(x=>x.id===editingMedId); m.photos = (m.photos||[]).concat(tempPhotos); Object.assign(m, data, {updated:Date.now()}); }
    else { state.meds.push({ id:uid('med'), created:Date.now(), updated:Date.now(), archived:false, photos:[...tempPhotos], ...data }); }
    save(); closeMedModal(); renderAll(); scheduleCheck();
  });
  $('#btnArchive')?.addEventListener('click', ()=>{ if(!editingMedId) return; setArchived(editingMedId, true); closeMedModal(); });

  // ====== Modal de carpeta ======
  let editingFolderId = null;
  function openFolderModal(id=null){ editingFolderId = id; $('#folderName').value = id ? (state.folders.find(f=>f.id===id)?.name||'') : ''; $('#folderModal').classList.add('open'); }
  function closeFolderModal(){ $('#folderModal').classList.remove('open'); }
  $('#closeFolderModal')?.addEventListener('click', closeFolderModal);
  $('#btnCancelFolder')?.addEventListener('click', closeFolderModal);
  $('#btnSaveFolder')?.addEventListener('click', ()=>{ const name=$('#folderName').value.trim(); if(!name) return; if(editingFolderId){ updateFolder(editingFolderId, name); } else { addFolder(name); } closeFolderModal(); });

  // ====== Papelera ======
  function openTrashModal(){ const body = $('#trashBody'); body.innerHTML=''; const meds = state.trash.meds; if(!meds.length){ body.innerHTML = '<div class="hint">La papelera está vacía</div>'; } else {
      meds.forEach(m=>{ const row=document.createElement('div'); row.className='row'; row.style.alignItems='center'; row.style.justifyContent='space-between'; row.style.padding='6px 0'; row.style.borderBottom='1px solid var(--border)'; row.innerHTML = `<div><strong>${m.name}</strong><div class="hint">${m.dose||''} · ${m.person||''}</div></div><div class="row"><button class="btn" data-restore="${m.id}">Restaurar</button><button class="btn danger" data-purge="${m.id}">Eliminar</button></div>`; body.appendChild(row); });
    }
    $('#trashModal').classList.add('open');
  }
  function closeTrashModal(){ $('#trashModal').classList.remove('open'); }
  $('#closeTrashModal')?.addEventListener('click', closeTrashModal);
  $('#btnCloseTrash')?.addEventListener('click', closeTrashModal);
  $('#btnPurgeAll')?.addEventListener('click', ()=>{ if(confirmBox('¿Eliminar definitivamente todo?')){ history.push(); state.trash.meds=[]; save(); openTrashModal(); }});
  document.body.addEventListener('click', (e)=>{
    const rid = e.target.getAttribute('data-restore'); if(rid){ history.push(); const m = state.trash.meds.find(x=>x.id===rid); if(m){ state.meds.push(m); state.trash.meds = state.trash.meds.filter(x=>x.id!==rid); save(); openTrashModal(); renderAll(); }
    }
    const pid = e.target.getAttribute('data-purge'); if(pid){ if(confirmBox('¿Eliminar definitivamente?')){ history.push(); state.trash.meds = state.trash.meds.filter(x=>x.id!==pid); save(); openTrashModal(); }}
  });

  // ====== Importar / Exportar ======
  function doExport(){ const data = JSON.stringify({...state, selected:[]}, null, 2); const blob = new Blob([data], {type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='botiquin.json'; a.click(); URL.revokeObjectURL(url); }
  function handleImport(e){ const file = e.target.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = () => { try{ const data = JSON.parse(reader.result); history.push(); state = {...data, selected:new Set()}; applyTheme(state.theme||'dark'); save(); renderAll(); }catch{ alert('JSON no válido'); } }; reader.readAsText(file); e.target.value=''; }

  // ====== Recordatorios ======
  async function enableNotifications(){ try{ const res = await Notification.requestPermission(); if(res==='granted'){ toast('Notificaciones activadas'); scheduleCheck(); } else { alert('Permiso de notificaciones denegado'); } }catch{ alert('Este navegador no soporta notificaciones'); } }
  let reminderTimer = null;
  function scheduleCheck(){ if(reminderTimer) clearInterval(reminderTimer); reminderTimer = setInterval(checkReminders, 30*1000); }
  function checkReminders(){ const now=Date.now(); state.meds.forEach(m=>{ if(m.nextDose && m.nextDose<=now && !m._fired){ m._fired=true; notify(`Toca tomar: ${m.name}`, m.dose||''); } }); }
  function notify(title, body){ if('Notification' in window && Notification.permission==='granted'){ new Notification(title, {body}); } alert(`${title}\n${body}`); }

  // ====== Inicialización y datos demo ======
  function ensureDemo(){ if(state.meds.length===0){ const ab = addFolder('Antibióticos'); const an = addFolder('Analgésicos'); const vt = addFolder('Vitaminas');
      history.push(); state.meds.push(
        {id:uid('med'), name:'Amoxicilina 500 mg', desc:'Infección respiratoria. Tomar con comida. Vigilar diarrea.', dose:'Cada 8h durante 5 días', person:'Laura', folderId:ab, tags:['urgente'], photos:[], created:Date.now(), updated:Date.now()},
        {id:uid('med'), name:'Ibuprofeno 400 mg', desc:'Dolor moderado. Evitar si hay gastritis.', dose:'Cada 8h si dolor', person:'Padre', folderId:an, photos:[], created:Date.now(), updated:Date.now()},
        {id:uid('med'), name:'Vitamina D3 2000 UI', desc:'Suplemento diario.', dose:'1 al día', person:'Bebé', folderId:vt, tags:['cronico'], photos:[], created:Date.now(), updated:Date.now()}
      ); save(); }
  }

  // ====== Start ======
  load(); bindEvents(); ensureDemo(); renderAll(); scheduleCheck();

  document.addEventListener('click', (e)=>{
    if(!state.selectMode) return; const card = e.target.closest('.card'); if(card && !e.target.closest('button,select,.checkbox,input')){ const id=card.dataset.id; if(state.selected.has(id)) state.selected.delete(id); else state.selected.add(id); updateSelectionUI(); save(); }
  });

  const observer = new MutationObserver(()=>{ $$('#cardsView .card').forEach(c=> attachCardDrag(c, c.dataset.id)); });
  observer.observe($('#cardsView'), {childList:true});

  </script>
</body>
</html>
