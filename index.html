<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<meta name="theme-color" content="#151925"/>
<title>Botiqu√≠n ¬∑ Gestor de Medicamentos (PWA)</title>
<style>
  :root{--bg:#0f1115;--panel:#151925;--sidebar:#1b2030;--text:#e6e8ee;--muted:#a8afc1;--primary:#5dd5c4;--accent:#a78bfa;--danger:#ef4444;--warning:#f59e0b;--success:#22c55e;--border:#2a3042;--card:#171c2a;--shadow:0 10px 30px rgba(0,0,0,.35)}
  .theme-light{--bg:#f7f8fb;--panel:#ffffff;--sidebar:#eef1f7;--text:#12141a;--muted:#616c7f;--primary:#2563eb;--accent:#14b8a6;--danger:#dc2626;--warning:#d97706;--success:#16a34a;--border:#e6e9f2;--card:#ffffff;--shadow:0 8px 24px rgba(0,0,0,.08)}
  .theme-olive{--bg:#0c1110;--panel:#101614;--sidebar:#0e1312;--text:#e8efe9;--muted:#a0b3a7;--primary:#7cc39b;--accent:#e7b75f;--danger:#e57373;--warning:#e0a545;--success:#65c18c;--border:#1e2a25;--card:#0f1715}
  .theme-aqua{--bg:#071418;--panel:#0b1d24;--sidebar:#08161b;--text:#e3f6fb;--muted:#98c0cc;--primary:#29b6f6;--accent:#22d3ee;--danger:#ef5350;--warning:#ffd54f;--success:#26c6da;--border:#12303a;--card:#0b1f27}
  .theme-amethyst{--bg:#0f0d14;--panel:#151225;--sidebar:#120f1f;--text:#efe9fb;--muted:#b7a7e6;--primary:#8b5cf6;--accent:#06b6d4;--danger:#f43f5e;--warning:#f59e0b;--success:#22c55e;--border:#231b3f;--card:#18132c}
  .theme-solar{--bg:#002b36;--panel:#073642;--sidebar:#05303a;--text:#eee8d5;--muted:#93a1a1;--primary:#b58900;--accent:#2aa198;--danger:#dc322f;--warning:#cb4b16;--success:#859900;--border:#0b3942;--card:#083440}

  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;-webkit-text-size-adjust:100%}
  [data-ink]{color:var(--text)!important}
  input,textarea,select,.btn,.pill,.hint,.counter{color:var(--text)}

  .app{display:grid;grid-template-columns:280px 1fr;height:100vh;min-width:0}
  .sidebar{background:var(--sidebar);border-right:1px solid var(--border);padding:16px 12px;overflow:auto}
  .main{display:flex;flex-direction:column;background:var(--panel);min-width:0}
  .topbar{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--panel);z-index:5;flex-wrap:wrap}
  .toolbar{display:flex;gap:8px;margin-left:auto;overflow:auto;max-width:100%}
  .btn{border:1px solid var(--border);background:transparent;padding:10px 12px;border-radius:12px;cursor:pointer;transition:.15s;display:inline-flex;align-items:center;gap:6px;white-space:nowrap}
  .btn:hover{background:color-mix(in srgb,var(--primary) 12%,transparent)}
  .btn.primary{border-color:color-mix(in srgb,var(--primary) 50%,var(--border));background:color-mix(in srgb,var(--primary) 18%,transparent)}
  .btn.danger{border-color:color-mix(in srgb,var(--danger) 50%,var(--border));background:color-mix(in srgb,var(--danger) 12%,transparent)}
  .search{flex:1;min-width:180px;max-width:520px;display:flex;align-items:center;gap:8px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:8px 10px}
  .search input{border:none;background:transparent;outline:none;width:100%}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:var(--card)}
  .folders-header{display:flex;align-items:center;justify-content:space-between;margin:10px 6px 6px}
  .folder-list{display:flex;flex-direction:column;gap:6px}
  .folder{display:flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:var(--card);cursor:pointer}
  .folder.active{outline:2px solid var(--primary)}
  .content{flex:1;overflow:auto;padding:0 12px 12px}

  .hero{position:relative;margin:10px 0 8px;border:1px solid var(--border);border-radius:14px;padding:14px;overflow:hidden;background:
    radial-gradient(1200px 300px at -10% -80%, color-mix(in srgb,var(--primary) 25%, transparent), transparent),
    radial-gradient(900px 240px at 120% -60%, color-mix(in srgb,var(--accent) 28%, transparent), transparent),
    var(--card);}
  .hero h1{margin:0;font-size:18px}
  .hero p{margin:6px 0 0;color:var(--muted)}
  .hero svg{position:absolute;right:8px;bottom:-6px;width:150px;opacity:.25}
  @media (max-width:480px){ .hero{display:none} }

  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px}
  .list{display:flex;flex-direction:column;gap:10px}

  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:8px;box-shadow:var(--shadow);min-width:0}
  .card.collapsed .photos,.card.collapsed .desc,.card.collapsed .meta,.card.collapsed .row{display:none}
  .card-header{display:flex;align-items:center;gap:8px;min-width:0}
  .title{font-weight:700;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .person{font-size:12px;color:var(--muted);border:1px solid var(--border);padding:2px 6px;border-radius:999px}
  .desc{color:var(--muted);display:-webkit-box;-webkit-line-clamp:5;-webkit-box-orient:vertical;overflow:hidden}
  .meta{display:flex;flex-wrap:wrap;gap:6px;color:var(--muted)}
  .tag{font-size:12px;border:1px dashed var(--border);padding:2px 6px;border-radius:999px}
  .photos{display:flex;gap:6px;flex-wrap:wrap}
  .thumb{width:60px;height:60px;border:1px solid var(--border);border-radius:8px;overflow:hidden;background:#0002;display:inline-flex;align-items:center;justify-content:center;position:relative}
  .thumb img{width:100%;height:100%;object-fit:cover}
  .thumb .x{position:absolute;top:2px;right:2px}

  .table{width:100%;border-collapse:collapse;background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden}
  .table th,.table td{padding:10px;border-bottom:1px solid var(--border)}
  .table th{text-align:left;color:var(--muted);font-weight:600;background:color-mix(in srgb,var(--card) 70%,var(--panel))}
  .table tr:hover td{background:color-mix(in srgb,var(--primary) 8%, transparent)}

  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:1000}
  .modal.open{display:flex}
  .dialog{background:var(--panel);border:1px solid var(--border);border-radius:16px;min-width:320px;max-width:860px;width:100%;box-shadow:var(--shadow);max-height:92vh;display:flex;flex-direction:column}
  .dialog .hd{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border);font-weight:700}
  .dialog .bd{padding:14px;display:grid;gap:10px;overflow:auto;-webkit-overflow-scrolling:touch}
  .dialog .ft{display:flex;justify-content:flex-end;gap:8px;padding:12px 14px;border-top:1px solid var(--border)}
  .field{display:grid;gap:6px}
  .field input,.field textarea,.field select{border:1px solid var(--border);background:var(--card);padding:10px;border-radius:12px;outline:none}

  html,body{overflow-x:hidden}
  @media (max-width: 820px){ .app{grid-template-columns:1fr} .sidebar{position:fixed;left:0;top:0;bottom:0;width:88vw;max-width:320px;transform:translateX(-110%);transition:.2s;z-index:1100} .sidebar.open{transform:translateX(0)} .content{padding:10px} .search{min-width:0}}
  .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:1050}
  .backdrop.show{display:block}
</style>
</head>
<body>
<div class="app" id="app">
  <aside class="sidebar" id="sidebar">
    <div class="folders-header" style="justify-content:flex-start;gap:8px">
      <button class="btn" id="btnCloseMenu" type="button" title="Cerrar men√∫">‚üµ</button>
      <strong data-ink>Carpetas</strong>
      <button class="btn" id="btnNewFolder" type="button" title="Nueva carpeta">Ôºã</button>
    </div>
    <div class="folder-list" id="folderList" aria-label="Lista de carpetas"></div>
    <hr style="border-color:var(--border);margin:12px 0"/>
    <div class="folders-header">
      <strong data-ink>Papelera</strong>
      <div>
        <button class="btn" id="btnTrash" type="button">Ver</button>
        <button class="btn danger" id="btnEmptyTrash" type="button">Vaciar</button>
      </div>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <button class="btn" id="btnMenu" type="button" aria-label="Abrir men√∫">‚ò∞</button>
      <div class="pill"><select id="viewSelect">
        <option value="cards">Cuadr√≠cula</option>
        <option value="list">Tarjetas alargadas</option>
        <option value="table">Tabla</option>
      </select></div>
      <div class="pill"><select id="sortSelect">
        <option value="name">Por nombre</option>
        <option value="nextDose">Por pr√≥xima toma</option>
        <option value="person">Por persona</option>
        <option value="updated">M√°s recientes</option>
      </select></div>
      <div class="search">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--muted)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        <input id="searchInput" placeholder="Buscar‚Ä¶ (nombre o persona)"/>
      </div>
      <div class="toolbar">
        <button class="btn" id="btnSelectMode" type="button">Seleccionar</button>
        <button class="btn danger" id="btnDeleteSelected" type="button" disabled>Eliminar sel.</button>
        <button class="btn" id="btnUndo" type="button" title="Ctrl+Z">‚Ü∂</button>
        <button class="btn" id="btnRedo" type="button" title="Ctrl+Y">‚Ü∑</button>
        <button class="btn primary" id="btnNewMed" type="button">+ Medicamento</button>
        <button class="btn" id="btnImport" type="button">Importar</button>
        <button class="btn" id="btnExport" type="button">Exportar</button>
        <button class="btn" id="btnNotify" type="button" title="Notificaciones">üîî</button>
        <button class="btn" id="btnTheme" type="button" title="Tema">üé®</button>
      </div>
    </div>

    <div class="content">
      <section class="hero" aria-label="Cabecera visual">
        <h1 data-ink>Tu botiqu√≠n, organizado</h1>
        <p data-ink>Optimizado para m√≥vil. Doble toque para plegar/desplegar tarjetas.</p>
        <svg viewBox="0 0 220 120" aria-hidden="true">
          <defs><linearGradient id="p1" x1="0" x2="1"><stop offset="0" stop-color="var(--primary)"/><stop offset="1" stop-color="var(--accent)"/></linearGradient></defs>
          <g opacity="0.9">
            <rect x="120" y="10" width="56" height="20" rx="4" fill="url(#p1)"/>
            <rect x="126" y="28" width="44" height="10" rx="3" fill="url(#p1)" opacity="0.8"/>
            <rect x="110" y="40" width="76" height="60" rx="14" fill="none" stroke="url(#p1)" stroke-width="4"/>
            <rect x="120" y="56" width="56" height="26" rx="8" fill="url(#p1)" opacity="0.16"/>
            <g transform="translate(18,55) rotate(-18)"><rect x="0" y="0" width="70" height="24" rx="12" fill="url(#p1)"/><rect x="0" y="0" width="35" height="24" rx="12" fill="var(--card)"/></g>
            <g transform="translate(34,78) rotate(12)"><rect x="0" y="0" width="70" height="24" rx="12" fill="url(#p1)"/><rect x="35" y="0" width="35" height="24" rx="12" fill="var(--card)"/></g>
          </g>
        </svg>
      </section>

      <div id="breadcrumb" class="hint" style="margin:0 0 10px 2px" data-ink></div>
      <div id="cardsView" class="grid" aria-live="polite"></div>
      <div id="listView" class="list" style="display:none"></div>
      <div id="tableView" style="display:none"></div>
    </div>
  </main>
</div>

<!-- Modal medicamento -->
<div class="modal" id="medModal" role="dialog" aria-modal="true">
  <div class="dialog">
    <div class="hd">Medicamento <button class="btn" id="closeMedModal" type="button">‚úï</button></div>
    <div class="bd">
      <div class="field"><label>Nombre *</label><input id="medName" placeholder="Ej. Amoxicilina 500 mg"/></div>
      <div class="field"><label>Descripci√≥n</label><textarea id="medDesc" placeholder="S√≠ntomas, notas (opcional)"></textarea></div>
      <div class="field"><label>Persona</label><input id="medPerson" placeholder="Ej. Laura, Beb√© (opcional)"/></div>
      <div class="field"><label>Carpeta</label><select id="medFolder"></select></div>
      <div class="field"><label>Etiquetas</label>
        <div class="pill"><input type="checkbox" id="tagUrgente"> Urgente</div>
        <div class="pill"><input type="checkbox" id="tagCronico"> Cr√≥nico</div>
        <div class="pill"><input type="checkbox" id="tagPrueba"> En prueba</div>
        <div class="pill"><input type="checkbox" id="tagPRN"> Cuando sea necesario</div>
      </div>
      <div class="field"><label>Pr√≥xima toma</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input type="datetime-local" id="medNext"/><span class="hint">(opcional)</span>
        </div>
      </div>
      <div class="field"><label>Fotos</label>
        <input type="file" id="medPhotos" accept="image/*" multiple/>
        <div class="photos" id="medPhotosPreview" style="margin-top:6px"></div>
        <div class="hint">Arrastra im√°genes aqu√≠ o sobre una tarjeta. Se reducen a 1200px.</div>
      </div>
    </div>
    <div class="ft">
      <button class="btn danger" id="btnArchive" type="button">Finalizar y archivar</button>
      <button class="btn" id="btnCancelEdit" type="button">Cancelar</button>
      <button class="btn primary" id="btnSaveMed" type="button">Guardar</button>
    </div>
  </div>
</div>

<!-- Modal carpeta -->
<div class="modal" id="folderModal" role="dialog" aria-modal="true">
  <div class="dialog">
    <div class="hd">Carpeta <button class="btn" id="closeFolderModal" type="button">‚úï</button></div>
    <div class="bd"><div class="field"><label>Nombre</label><input id="folderName" placeholder="Ej. Antibi√≥ticos"/></div></div>
    <div class="ft"><button class="btn" id="btnCancelFolder" type="button">Cancelar</button><button class="btn primary" id="btnSaveFolder" type="button">Guardar</button></div>
  </div>
</div>

<!-- Modal papelera -->
<div class="modal" id="trashModal" role="dialog" aria-modal="true">
  <div class="dialog">
    <div class="hd">Papelera <button class="btn" id="closeTrashModal" type="button">‚úï</button></div>
    <div class="bd" id="trashBody"></div>
    <div class="ft"><button class="btn danger" id="btnPurgeAll" type="button">Eliminar definitivamente</button><button class="btn" id="btnCloseTrash" type="button">Cerrar</button></div>
  </div>
</div>

<input type="file" id="fileInput" accept="application/json" style="display:none"/>
<div id="backdrop" class="backdrop"></div>

<script>
const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
const uid=(p='id')=>p+'_'+Math.random().toString(36).slice(2,9);
const confirmBox=msg=>window.confirm(msg);

const STORAGE_KEY='botiquin.v4'; // nueva versi√≥n (evita conflictos con estados previos)
let state={
  folders:[{id:'all',name:'Todos',order:0}],
  meds:[],
  trash:{meds:[],folders:[]},
  view:'cards', sort:'name', theme:'dark', activeFolder:'all',
  selectMode:false, selected:new Set(), collapsed:{}
};
const history={undo:[],redo:[],push(){this.undo.push(JSON.stringify(state)); if(this.undo.length>50)this.undo.shift(); this.redo.length=0;},
  canUndo(){return this.undo.length>0}, canRedo(){return this.redo.length>0},
  doUndo(){if(!this.canUndo())return; this.redo.push(JSON.stringify(state)); state=JSON.parse(this.undo.pop()); state.selected=new Set(state.selected||[]); renderAll(); save();},
  doRedo(){if(!this.canRedo())return; this.undo.push(JSON.stringify(state)); state=JSON.parse(this.redo.pop()); state.selected=new Set(state.selected||[]); renderAll(); save();}
};

function load(){const raw=localStorage.getItem(STORAGE_KEY); if(raw){try{state=JSON.parse(raw); state.selected=new Set(state.selected||[]);}catch{}} applyTheme(state.theme);}
function save(){localStorage.setItem(STORAGE_KEY, JSON.stringify({...state,selected:[...state.selected]}));}

const THEMES=['dark','light','olive','aqua','amethyst','solar'];
function applyTheme(name){document.body.classList.remove(...THEMES.map(t=>'theme-'+t)); if(name!=='dark')document.body.classList.add('theme-'+name); state.theme=name||'dark'; const m=document.querySelector('meta[name="theme-color"]'); if(m)m.setAttribute('content',getComputedStyle(document.documentElement).getPropertyValue('--panel').trim()); save();}

function addFolder(name){history.push(); const id=uid('fld'); state.folders.push({id,name,order:Date.now()}); save(); renderFolders(); renderAll(); return id;}
function updateFolder(id,name){history.push(); const f=state.folders.find(x=>x.id===id); if(f){f.name=name; save(); renderFolders(); renderAll();}}
function deleteFolder(id){if(id==='all')return; if(!confirmBox('¬øEliminar carpeta y mover a "Todos"?'))return; history.push(); state.trash.folders.push(state.folders.find(f=>f.id===id)); state.folders=state.folders.filter(f=>f.id!==id); state.meds.forEach(m=>{if(m.folderId===id)m.folderId='all';}); save(); renderFolders(); renderAll();}
let draggingFolderId=null;
function renderFolders(){const list=$('#folderList'); list.innerHTML=''; state.folders.sort((a,b)=> (a.id==='all')?-1:(b.id==='all')?1:a.order-b.order);
  state.folders.forEach(f=>{const el=document.createElement('div'); el.className='folder'+(f.id===state.activeFolder?' active':''); el.draggable=f.id!=='all'; el.dataset.id=f.id;
    el.innerHTML=`<span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${f.name}</span>
    <div style="display:flex;gap:4px">${f.id!=='all'?'<button class="btn btnFolderRename" type="button" title="Renombrar">‚úé</button>':''}${f.id!=='all'?'<button class="btn btnFolderDelete" type="button" title="Eliminar">üóë</button>':''}</div>`;
    el.addEventListener('click',e=>{if(e.target.closest('.btn'))return; state.activeFolder=f.id; renderAll(); save();});
    if(f.id!=='all'){el.addEventListener('dragstart',()=>{draggingFolderId=f.id; el.style.opacity=.5;}); el.addEventListener('dragend',()=>{draggingFolderId=null; el.style.opacity=1;});
      el.addEventListener('dragover',e=>{e.preventDefault(); el.style.outline='2px dashed var(--primary)';});
      el.addEventListener('dragleave',()=>{el.style.outline='';});
      el.addEventListener('drop',()=>{el.style.outline=''; history.push(); const src=state.folders.find(x=>x.id===draggingFolderId); const dst=state.folders.find(x=>x.id===f.id); if(src&&dst&&src.id!==dst.id){src.order=dst.order-1; save(); renderFolders();}});}
    el.addEventListener('dragover',e=>e.preventDefault());
    el.addEventListener('drop',e=>{const ids=(e.dataTransfer?.getData('text/med-ids')||'').split(',').filter(Boolean); if(!ids.length)return; history.push(); ids.forEach(id=>{const m=state.meds.find(x=>x.id===id); if(m)m.folderId=f.id;}); save(); renderAll();});
    list.appendChild(el);
  });
}

let editingMedId=null;
function newMed(){editingMedId=null; openMedModal();}
function editMed(id){editingMedId=id; openMedModal(id);}
function duplicateMed(id){const src=state.meds.find(m=>m.id===id); if(!src)return; history.push(); const copy={...src,id:uid('med'),name:src.name+' (copia)',created:Date.now(),updated:Date.now()}; state.meds.push(copy); save(); renderAll();}
function removeMed(id){history.push(); const m=state.meds.find(x=>x.id===id); if(!m)return; state.trash.meds.push(m); state.meds=state.meds.filter(x=>x.id!==id); save(); renderAll();}
function removeSelected(){if(!state.selected.size)return; if(!confirmBox(`¬øEliminar ${state.selected.size} seleccionados?`))return; history.push(); const ids=[...state.selected]; ids.forEach(id=>{const m=state.meds.find(x=>x.id===id); if(m)state.trash.meds.push(m);}); state.meds=state.meds.filter(m=>!state.selected.has(m.id)); state.selected.clear(); save(); renderAll();}
function setArchived(id,flag=true){history.push(); const m=state.meds.find(x=>x.id===id); if(m){m.archived=!!flag; m.updated=Date.now(); save(); renderAll();}}
function attachCardDrag(el,id){el.draggable=true;
  el.addEventListener('dragstart',e=>{const ids=state.selectMode&&state.selected.size?[...state.selected]:[id]; e.dataTransfer.setData('text/med-ids',ids.join(',')); el.classList.add('dragging');});
  el.addEventListener('dragend',()=>el.classList.remove('dragging'));
  el.addEventListener('dragover',e=>{if([...e.dataTransfer.items].some(i=>i.kind==='file')){e.preventDefault(); el.style.outline='2px dashed var(--primary)';}});
  el.addEventListener('dragleave',()=>el.style.outline='');
  el.addEventListener('drop',async e=>{if(![...e.dataTransfer.items].some(i=>i.kind==='file'))return; e.preventDefault(); el.style.outline=''; const files=[...e.dataTransfer.files].filter(f=>f.type.startsWith('image/')); if(!files.length)return; history.push(); const m=state.meds.find(x=>x.id===id); if(!m)return; m.photos=m.photos||[]; for(const f of files){const data=await fileToResizedDataURL(f,1200); m.photos.push(data);} m.updated=Date.now(); save(); renderAll();});
}

function currentMeds(){let meds=state.meds.filter(m=>!m.archived); if(state.activeFolder!=='all')meds=meds.filter(m=>m.folderId===state.activeFolder); const q=$('#searchInput').value.trim().toLowerCase(); if(q)meds=meds.filter(m=>(m.name+' '+(m.person||'')).toLowerCase().includes(q)); meds.sort((a,b)=>{switch(state.sort){case'person':return (a.person||'').localeCompare(b.person||'')||a.name.localeCompare(b.name);case'updated':return (b.updated||0)-(a.updated||0);case'nextDose':return (a.nextDose||Infinity)-(b.nextDose||Infinity);default:return a.name.localeCompare(b.name);}}); return meds;}

function renderAll(){
  renderFolders(); renderBreadcrumb();
  const v=state.view||'cards';
  $('#cardsView').style.display=(v==='cards')?'grid':'none';
  $('#listView').style.display=(v==='list')?'flex':'none';
  $('#tableView').style.display=(v==='table')?'block':'none';
  if(v==='cards')renderCards(); else if(v==='list')renderList(); else renderTable();
  updateSelectionUI(); updateUndoRedoUI(); populateFolderSelect();
}
function renderBreadcrumb(){const f=state.folders.find(x=>x.id===state.activeFolder); $('#breadcrumb').textContent=`Carpeta: ${f?f.name:'(desconocida)'} ‚Ä¢ ${currentMeds().length} elementos`;}

function tagBadges(m){return `
  ${m.tags?.includes('urgente')?'<span class="tag" style="border-color:var(--danger);color:var(--danger)">Urgente</span>':''}
  ${m.tags?.includes('cronico')?'<span class="tag" style="border-color:var(--warning);color:var(--warning)">Cr√≥nico</span>':''}
  ${m.tags?.includes('prueba')?'<span class="tag" style="border-color:var(--accent);color:var(--accent)">En prueba</span>':''}
  ${m.tags?.includes('prn')?'<span class="tag" style="border-color:var(--success);color:var(--success)">Cuando sea necesario</span>':''}
  ${m.nextDose?'<span class="tag">‚è∞ '+new Date(m.nextDose).toLocaleString()+'</span>':''}`;}

function actionButtons(id){return `
  <button class="btn" data-edit="${id}" type="button">Editar</button>
  <button class="btn" data-copy="${id}" type="button">Copiar</button>
  <button class="btn" data-dup="${id}" type="button">Duplicar</button>
  <button class="btn danger" data-del="${id}" type="button">Eliminar</button>`;}

function renderCards(){const wrap=$('#cardsView'); wrap.innerHTML=''; currentMeds().forEach(m=>{const card=document.createElement('div'); const collapsed=!!state.collapsed[m.id]; card.className='card'+(collapsed?' collapsed':''); card.dataset.id=m.id; attachCardDrag(card,m.id);
  card.addEventListener('dblclick',()=>{state.collapsed[m.id]=!state.collapsed[m.id]; save(); renderAll();});
  card.addEventListener('touchend',(e)=>{if(e.detail===2){state.collapsed[m.id]=!state.collapsed[m.id]; save(); renderAll();}});
  const photos=(m.photos||[]).slice(0,4).map(src=>`<span class="thumb"><img src="${src}" alt="foto"/></span>`).join('');
  card.innerHTML=`
    <div class="card-header">
      <div class="title" data-ink>${m.name}</div>
      <div class="person">${m.person||'‚Äî'}</div>
    </div>
    ${photos?'<div class="photos">'+photos+'</div>':''}
    <div class="desc" data-ink>${m.desc||'‚Äî'}</div>
    <div class="meta" data-ink>${tagBadges(m)}</div>
    <div class="row" style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
      <select data-move="${m.id}" title="Mover a carpeta">
        ${state.folders.map(f=>`<option value="${f.id}" ${m.folderId===f.id?'selected':''}>${f.name}</option>`).join('')}
      </select>
      <span style="flex:1"></span>
      ${actionButtons(m.id)}
    </div>`;
  wrap.appendChild(card);
});}

function renderList(){const wrap=$('#listView'); wrap.innerHTML=''; currentMeds().forEach(m=>{const card=document.createElement('div'); const collapsed=!!state.collapsed[m.id]; card.className='card'+(collapsed?' collapsed':''); card.dataset.id=m.id; attachCardDrag(card,m.id);
  card.addEventListener('dblclick',()=>{state.collapsed[m.id]=!state.collapsed[m.id]; save(); renderAll();});
  card.addEventListener('touchend',(e)=>{if(e.detail===2){state.collapsed[m.id]=!state.collapsed[m.id]; save(); renderAll();}});
  card.innerHTML=`
    <div>
      <div class="card-header"><div class="title" data-ink>${m.name}</div><div class="person">${m.person||'‚Äî'}</div></div>
      <div class="desc" data-ink>${m.desc||'‚Äî'}</div>
      <div class="meta" data-ink>${tagBadges(m)}</div>
    </div>
    <div class="row" style="justify-content:flex-end">${actionButtons(m.id)}</div>`;
  wrap.appendChild(card);
});}

function renderTable(){const meds=currentMeds(); const wrap=$('#tableView'); const rows=meds.map(m=>`<tr data-id="${m.id}">
  <td>${m.name}</td><td>${m.person||'‚Äî'}</td><td>${m.desc||'‚Äî'}</td><td>${m.nextDose?new Date(m.nextDose).toLocaleString():'‚Äî'}</td>
  <td><button class="btn" data-edit="${m.id}" type="button">Editar</button> <button class="btn" data-copy="${m.id}" type="button">Copiar</button> <button class="btn" data-dup="${m.id}" type="button">Duplicar</button> <button class="btn danger" data-del="${m.id}" type="button">Eliminar</button></td>
`).join(''); wrap.innerHTML=`<table class="table"><thead><tr><th>Nombre</th><th>Persona</th><th>Descripci√≥n</th><th>Pr√≥xima toma</th><th>Acciones</th></tr></thead><tbody>${rows}</tbody></table>`;}

function updateSelectionUI(){ $('#btnDeleteSelected').disabled=state.selected.size===0; }
function updateUndoRedoUI(){ $('#btnUndo').disabled=!history.canUndo(); $('#btnRedo').disabled=!history.canRedo(); }

let editingFolderId=null;
function openFolderModal(id){editingFolderId=id||null; $('#folderName').value=id?(state.folders.find(f=>f.id===id)?.name||''):''; $('#folderModal').classList.add('open'); setTimeout(()=>$('#folderName').focus(),30);}
function closeFolderModal(){$('#folderModal').classList.remove('open'); editingFolderId=null;}
function saveFolderFromModal(){const name=$('#folderName').value.trim(); if(!name)return alert('Pon un nombre'); if(editingFolderId){updateFolder(editingFolderId,name);} else {const newId=addFolder(name); state.activeFolder=newId;} save(); renderAll(); closeFolderModal();}

document.addEventListener('click',e=>{
  const editBtn=e.target.closest('button[data-edit]'); if(editBtn){editMed(editBtn.getAttribute('data-edit')); return;}
  const copyBtn=e.target.closest('button[data-copy]'); if(copyBtn){copyMed(copyBtn.getAttribute('data-copy')); return;}
  const dupBtn=e.target.closest('button[data-dup]'); if(dupBtn){duplicateMed(dupBtn.getAttribute('data-dup')); return;}
  const delBtn=e.target.closest('button[data-del]'); if(delBtn){if(confirmBox('¬øEliminar este medicamento?'))removeMed(delBtn.getAttribute('data-del')); return;}
  if(e.target.id==='btnSaveFolder')saveFolderFromModal();
  if(e.target.id==='closeFolderModal'||e.target.id==='btnCancelFolder')closeFolderModal();
  if(e.target.id==='btnPurgeAll'){if(confirmBox('¬øEliminar definitivamente todo?')){history.push(); state.trash.meds=[]; save(); openTrashModal();}}
  if(e.target.id==='btnCloseTrash'||e.target.id==='closeTrashModal')closeTrashModal();
  if(e.target.id==='btnCancelEdit'||e.target.id==='closeMedModal')closeMedModal();
});

document.body.addEventListener('click',e=>{
  const rn=e.target.closest('.btnFolderRename'); if(rn){openFolderModal(rn.closest('.folder').dataset.id); return;}
  const dl=e.target.closest('.btnFolderDelete'); if(dl){const id=dl.closest('.folder').dataset.id; if(confirmBox('¬øEliminar carpeta?'))deleteFolder(id); return;}
});

function closeSidebar(){$('#sidebar').classList.remove('open'); $('#backdrop').classList.remove('show');}

function bindEvents(){
  $('#btnMenu').addEventListener('click',()=>{$('#sidebar').classList.add('open'); $('#backdrop').classList.add('show');});
  $('#btnCloseMenu').addEventListener('click',closeSidebar);
  $('#backdrop').addEventListener('click',closeSidebar);

  $('#btnTheme').addEventListener('click',()=>{const i=THEMES.indexOf(state.theme); const next=THEMES[(i+1)%THEMES.length]; applyTheme(next);});
  $('#btnNewMed').addEventListener('click',newMed);
  $('#btnNewFolder').addEventListener('click',()=>openFolderModal());
  $('#btnUndo').addEventListener('click',()=>history.doUndo());
  $('#btnRedo').addEventListener('click',()=>history.doRedo());
  $('#btnExport').addEventListener('click',doExport);
  $('#btnImport').addEventListener('click',()=>$('#fileInput').click());
  $('#fileInput').addEventListener('change',handleImport);
  $('#btnNotify').addEventListener('click',enableNotifications);
  $('#btnTrash').addEventListener('click',openTrashModal);
  $('#btnEmptyTrash').addEventListener('click',()=>{if(confirmBox('¬øVaciar la papelera?')){history.push(); state.trash.meds=[]; state.trash.folders=[]; save();}});

  $('#searchInput').addEventListener('input',renderAll);
  $('#viewSelect').value=state.view||'cards';
  $('#sortSelect').value=state.sort||'name';
  $('#viewSelect').addEventListener('change',e=>{state.view=e.target.value; save(); renderAll();});
  $('#sortSelect').addEventListener('change',e=>{state.sort=e.target.value; save(); renderAll();});

  document.addEventListener('keydown',e=>{ if(e.key==='Escape')closeSidebar(); });

  document.body.addEventListener('change',e=>{
    const moveId=e.target.getAttribute('data-move'); if(moveId){history.push(); const m=state.meds.find(x=>x.id===moveId); if(m){m.folderId=e.target.value; m.updated=Date.now(); save();}}
  });
}

function toast(msg){const t=document.createElement('div'); t.textContent=msg; Object.assign(t.style,{position:'fixed',bottom:'16px',left:'50%',transform:'translateX(-50%)',background:'var(--card)',border:'1px solid var(--border)',padding:'10px 12px',borderRadius:'10px',boxShadow:'var(--shadow)',zIndex:2000,color:'var(--text)'}); document.body.appendChild(t); setTimeout(()=>t.remove(),1800);}

async function copyMed(id){const m=state.meds.find(x=>x.id===id); if(!m)return; const txt=`${m.name}\n${m.person||''}\n${m.desc||''}`.trim(); try{await navigator.clipboard.writeText(txt); toast('Copiado');}catch{alert('No se pudo copiar');}}

let tempPhotos=[]; let existingPhotos=[];
async function previewPhotos(files){for(const f of files){if(!f.type.startsWith('image/'))continue; const data=await fileToResizedDataURL(f,1200); tempPhotos.push(data);} paintPhotosPreview();}
function paintPhotosPreview(){const box=$('#medPhotosPreview'); box.innerHTML='';
  existingPhotos.forEach((src,i)=>{const d=document.createElement('div'); d.className='thumb'; d.innerHTML=`<img src="${src}" alt="foto"/><button class="btn danger x" data-delphoto-ex="${i}" type="button">‚úï</button>`; box.appendChild(d);});
  tempPhotos.forEach((src,i)=>{const d=document.createElement('div'); d.className='thumb'; d.innerHTML=`<img src="${src}" alt="foto"/><button class="btn danger x" data-delphoto-tmp="${i}" type="button">‚úï</button>`; box.appendChild(d);});
  box.querySelectorAll('[data-delphoto-ex]').forEach(b=>b.addEventListener('click',()=>{const i=+b.getAttribute('data-delphoto-ex'); existingPhotos.splice(i,1); paintPhotosPreview();}));
  box.querySelectorAll('[data-delphoto-tmp]').forEach(b=>b.addEventListener('click',()=>{const i=+b.getAttribute('data-delphoto-tmp'); tempPhotos.splice(i,1); paintPhotosPreview();}));
}
async function fileToResizedDataURL(file,maxSide=1200){const img=await new Promise(res=>{const r=new FileReader(); r.onload=()=>{const i=new Image(); i.onload=()=>res(i); i.src=r.result;}; r.readAsDataURL(file);}); const scale=Math.min(1,maxSide/Math.max(img.width,img.height)); const w=Math.round(img.width*scale), h=Math.round(img.height*scale); const c=document.createElement('canvas'); c.width=w; c.height=h; const ctx=c.getContext('2d'); ctx.fillStyle='#fff'; ctx.fillRect(0,0,w,h); ctx.drawImage(img,0,0,w,h); return c.toDataURL('image/jpeg',0.85);}

function openMedModal(id){
  tempPhotos=[];
  const m=id?state.meds.find(x=>x.id===id):{name:'',desc:'',person:'',folderId:state.activeFolder,tags:[],nextDose:null,photos:[]};
  existingPhotos=(m.photos||[]).slice();
  $('#medName').value=m.name||'';
  $('#medDesc').value=m.desc||'';
  $('#medPerson').value=m.person||'';
  $('#medNext').value=m.nextDose?new Date(m.nextDose).toISOString().slice(0,16):'';
  populateFolderSelect(); $('#medFolder').value=m.folderId||state.activeFolder;
  $('#tagUrgente').checked=m.tags?.includes('urgente');
  $('#tagCronico').checked=m.tags?.includes('cronico');
  $('#tagPrueba').checked=m.tags?.includes('prueba');
  $('#tagPRN').checked=m.tags?.includes('prn');
  paintPhotosPreview();
  $('#medModal').classList.add('open');
}
function closeMedModal(){$('#medModal').classList.remove('open'); tempPhotos=[]; existingPhotos=[];}
function populateFolderSelect(){const sel=$('#medFolder'); if(!sel)return; sel.innerHTML=state.folders.map(f=>`<option value="${f.id}">${f.name}</option>`).join('');}
document.addEventListener('change',e=>{if(e.target.id==='medPhotos'){const files=[...e.target.files]; previewPhotos(files);}});
$('#medModal').addEventListener('dragover',e=>{if(e.target.closest('#medPhotosPreview'))e.preventDefault();});
$('#medModal').addEventListener('drop',async e=>{if(!e.target.closest('#medPhotosPreview'))return; e.preventDefault(); const files=[...e.dataTransfer.files].filter(f=>f.type.startsWith('image/')); await previewPhotos(files);});

document.addEventListener('click',e=>{
  if(e.target.id==='btnSaveMed' || e.target.id==='btnArchive'){
    const data={
      name:$('#medName').value.trim(),
      desc:$('#medDesc').value.trim(),
      person:$('#medPerson').value.trim(),
      folderId:$('#medFolder').value,
      tags:[ $('#tagUrgente').checked&&'urgente', $('#tagCronico').checked&&'cronico', $('#tagPrueba').checked&&'prueba', $('#tagPRN').checked&&'prn' ].filter(Boolean),
      nextDose:$('#medNext').value?new Date($('#medNext').value).getTime():null
    };
    if(!data.name) return alert('Pon un nombre de medicamento');
    const archivar=(e.target.id==='btnArchive');
    history.push();
    if(editingMedId){
      const m=state.meds.find(x=>x.id===editingMedId);
      m.photos=existingPhotos.concat(tempPhotos);
      Object.assign(m,data,{updated:Date.now(), archived:archivar?true:m.archived});
    } else {
      state.meds.push({id:uid('med'),created:Date.now(),updated:Date.now(),archived:archivar,photos:existingPhotos.concat(tempPhotos),...data});
    }
    save(); closeMedModal(); renderAll(); scheduleCheck();
  }
  if(e.target.id==='btnCancelEdit'||e.target.id==='closeMedModal')closeMedModal();
});

function openTrashModal(){const body=$('#trashBody'); body.innerHTML=''; const meds=state.trash.meds;
  if(!meds.length){body.innerHTML='<div class="hint">La papelera est√° vac√≠a</div>';}
  else {meds.forEach(m=>{const row=document.createElement('div'); row.style.cssText='display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border)'; row.innerHTML=`<div><strong>${m.name}</strong><div class="hint">${m.person||''}</div></div><div><button class="btn" data-restore="${m.id}" type="button">Restaurar</button><button class="btn danger" data-purge="${m.id}" type="button">Eliminar</button></div>`; body.appendChild(row);});}
  $('#trashModal').classList.add('open');
}
function closeTrashModal(){$('#trashModal').classList.remove('open');}
document.body.addEventListener('click',e=>{
  const rid=e.target.getAttribute('data-restore'); if(rid){history.push(); const m=state.trash.meds.find(x=>x.id===rid); if(m){state.meds.push(m); state.trash.meds=state.trash.meds.filter(x=>x.id!==rid); save(); openTrashModal(); renderAll();}}
  const pid=e.target.getAttribute('data-purge'); if(pid){if(confirmBox('¬øEliminar definitivamente?')){history.push(); state.trash.meds=state.trash.meds.filter(x=>x.id!==pid); save(); openTrashModal();}}
});
document.addEventListener('click',e=>{if(e.target.id==='btnCloseTrash'||e.target.id==='closeTrashModal')closeTrashModal();});

function doExport(){const data=JSON.stringify({...state,selected:[]},null,2); const url=URL.createObjectURL(new Blob([data],{type:'application/json'})); const a=document.createElement('a'); a.href=url; a.download='botiquin.json'; a.click(); URL.revokeObjectURL(url);}
function handleImport(e){const file=e.target.files[0]; if(!file)return; const r=new FileReader(); r.onload=()=>{try{const data=JSON.parse(r.result); history.push(); state={...data,selected:new Set(state.selected||[])}; applyTheme(state.theme||'dark'); save(); renderAll();}catch{alert('JSON no v√°lido');}}; r.readAsText(file); e.target.value='';}

async function enableNotifications(){try{const res=await Notification.requestPermission(); if(res==='granted'){toast('Notificaciones activadas'); scheduleCheck();} else {alert('Permiso de notificaciones denegado');}}catch{alert('Este navegador no soporta notificaciones');}}
let reminderTimer=null; function scheduleCheck(){if(reminderTimer)clearInterval(reminderTimer); reminderTimer=setInterval(checkReminders,30*1000);}
function checkReminders(){const now=Date.now(); state.meds.forEach(m=>{if(m.nextDose && m.nextDose<=now && !m._fired){m._fired=true; notify(`Toca tomar: ${m.name}`, m.person||'');}});}
function notify(title,body){if('Notification'in window && Notification.permission==='granted'){new Notification(title,{body});} alert(`${title}\n${body}`);}

function ensureDemo(){ if(state.meds.length===0){const ab=addFolder('Antibi√≥ticos'), an=addFolder('Analg√©sicos'), vt=addFolder('Vitaminas'); history.push(); state.meds.push(
  {id:uid('med'),name:'Amoxicilina 500 mg',desc:'Infecci√≥n respiratoria.',person:'Laura',folderId:ab,tags:['urgente'],photos:[],created:Date.now(),updated:Date.now()},
  {id:uid('med'),name:'Ibuprofeno 400 mg',desc:'Dolor moderado.',person:'Padre',folderId:an,photos:[],created:Date.now(),updated:Date.now()},
  {id:uid('med'),name:'Vitamina D3 2000 UI',desc:'Suplemento diario.',person:'Beb√©',folderId:vt,tags:['cronico','prn'],photos:[],created:Date.now(),updated:Date.now()}
); save();}}

function bindGlobal(){
  document.body.addEventListener('change',e=>{
    const moveId=e.target.getAttribute('data-move'); if(moveId){history.push(); const m=state.meds.find(x=>x.id===moveId); if(m){m.folderId=e.target.value; m.updated=Date.now(); save();}}
  });
  // doble-clic/tap ya agregado por tarjeta
}

function init(){
  load(); bindEvents(); bindGlobal(); ensureDemo(); renderAll(); scheduleCheck();
  const obs=new MutationObserver(()=>{$$('#cardsView .card').forEach(c=>attachCardDrag(c,c.dataset.id)); $$('#listView .card').forEach(c=>attachCardDrag(c,c.dataset.id));}); obs.observe(document.body,{childList:true,subtree:true});
}
init();
</script>
</body>
</html>
