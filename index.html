<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#151925" />
  <title>Botiquín · Gestor de Medicamentos (PWA)</title>
  <style>
    :root{--bg:#0f1115;--panel:#151925;--sidebar:#1b2030;--text:#e6e8ee;--muted:#a8afc1;--primary:#5dd5c4;--accent:#a78bfa;--danger:#ef4444;--warning:#f59e0b;--success:#22c55e;--border:#2a3042;--card:#171c2a;--shadow:0 10px 30px rgba(0,0,0,.35)}
    .theme-light{--bg:#f7f8fb;--panel:#ffffff;--sidebar:#eef1f7;--text:#12141a;--muted:#616c7f;--primary:#2563eb;--accent:#14b8a6;--danger:#dc2626;--warning:#d97706;--success:#16a34a;--border:#e6e9f2;--card:#ffffff;--shadow:0 8px 24px rgba(0,0,0,.08)}
    .theme-olive{--bg:#0c1110;--panel:#101614;--sidebar:#0e1312;--text:#e8efe9;--muted:#a0b3a7;--primary:#7cc39b;--accent:#e7b75f;--danger:#e57373;--warning:#e0a545;--success:#65c18c;--border:#1e2a25;--card:#0f1715}
    .theme-aqua{--bg:#071418;--panel:#0b1d24;--sidebar:#08161b;--text:#e3f6fb;--muted:#98c0cc;--primary:#29b6f6;--accent:#22d3ee;--danger:#ef5350;--warning:#ffd54f;--success:#26c6da;--border:#12303a;--card:#0b1f27}
    .theme-amethyst{--bg:#0f0d14;--panel:#151225;--sidebar:#120f1f;--text:#efe9fb;--muted:#b7a7e6;--primary:#8b5cf6;--accent:#06b6d4;--danger:#f43f5e;--warning:#f59e0b;--success:#22c55e;--border:#231b3f;--card:#18132c}
    .theme-solar{--bg:#002b36;--panel:#073642;--sidebar:#05303a;--text:#eee8d5;--muted:#93a1a1;--primary:#b58900;--accent:#2aa198;--danger:#dc322f;--warning:#cb4b16;--success:#859900;--border:#0b3942;--card:#083440}

    *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial}
    [data-ink]{ color: var(--text) !important; }
    .btn, .pill, .hint, .counter { color: var(--text); }
    .field input,.field textarea,.field select { color: var(--text); }
    .table td, .table th { color: var(--text); }

    .app{display:grid;grid-template-columns:260px 1fr;height:100vh;min-width:0}
    .sidebar{background:var(--sidebar);border-right:1px solid var(--border);padding:16px 12px;overflow:auto}
    .main{display:flex;flex-direction:column;background:var(--panel);min-width:0}
    .topbar{display:flex;align-items:center;gap:8px;padding:10px 14px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--panel);z-index:5;flex-wrap:wrap}
    .topbar>*{min-width:0}
    .logo{display:flex;align-items:center;gap:10px;font-weight:700}
    .logo svg{width:26px;height:26px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-left:auto;min-width:0;overflow:auto;max-width:100%}
    .toolbar .group{display:flex;gap:6px}
    .btn{border:1px solid var(--border);background:transparent;padding:8px 10px;border-radius:10px;cursor:pointer;transition:.15s ease;display:inline-flex;align-items:center;gap:6px;white-space:nowrap}
    .btn:hover{background:color-mix(in srgb, var(--primary) 10%, transparent)}
    .btn.primary{border-color:color-mix(in srgb, var(--primary) 50%, var(--border));background:color-mix(in srgb, var(--primary) 15%, transparent)}
    .btn.danger{border-color:color-mix(in srgb, var(--danger) 50%, var(--border));background:color-mix(in srgb, var(--danger) 10%, transparent)}
    .btn:disabled{opacity:.5;pointer-events:none}
    .search{flex:1;min-width:220px;max-width:520px;display:flex;align-items:center;gap:8px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:6px 10px}
    .search input{border:none;background:transparent;outline:none;width:100%; color: var(--text); }
    .folders-header{display:flex;align-items:center;justify-content:space-between;margin:10px 6px 6px}
    .folder-list{display:flex;flex-direction:column;gap:6px}
    .folder{display:flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:var(--card);cursor:pointer}
    .folder.active{outline:2px solid var(--primary)}
    .folder-name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .folder-actions{display:flex;gap:4px}
    .content{flex:1;overflow:auto;padding:0 16px 16px}

    /* HERO (ilustración) */
    .hero{position:relative;margin:12px 0 8px;border:1px solid var(--border);border-radius:14px;padding:16px;overflow:hidden;background:
      radial-gradient(1200px 300px at -10% -80%, color-mix(in srgb,var(--primary) 25%, transparent), transparent),
      radial-gradient(900px 240px at 120% -60%, color-mix(in srgb,var(--accent) 28%, transparent), transparent),
      var(--card);
    }
    .hero h1{margin:0;font-size:20px}
    .hero p{margin:6px 0 0;color:var(--muted)}
    .hero svg{position:absolute;right:10px;bottom:-6px;width:180px;opacity:.25}

    .grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(320px, 1fr));gap:12px}
    .list{display:flex;flex-direction:column;gap:10px}
    .list .card{display:grid;grid-template-columns:1fr auto;align-items:center}
    .list .desc{-webkit-line-clamp:2}

    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:8px;box-shadow:var(--shadow);min-width:0;user-select:none}
    .card.dragging{opacity:.6}
    .card.collapsed .photos,.card.collapsed .desc,.card.collapsed .meta,.card.collapsed .row{display:none}
    .card-header{display:flex;align-items:center;gap:8px;min-width:0}
    .title{font-weight:700;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap; cursor:default}
    .person{font-size:12px;color:var(--muted);border:1px solid var(--border);padding:2px 6px;border-radius:999px}
    .desc{color:var(--muted);display:-webkit-box;-webkit-line-clamp:5;-webkit-box-orient:vertical;overflow:hidden}
    .meta{display:flex;flex-wrap:wrap;gap:6px;color:var(--muted)}
    .tag{font-size:12px;border:1px dashed var(--border);padding:2px 6px;border-radius:999px}
    .row{display:flex;flex-wrap:wrap;gap:8px}
    .row select,.row button{min-height:34px}
    .row .spacer{flex:1}
    .checkbox{display:none}
    .select-mode .checkbox{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border:1px solid var(--border);border-radius:4px}
    .checkbox input{appearance:none;width:14px;height:14px;border-radius:3px;border:1px solid var(--border)}
    .checkbox input:checked{background:var(--primary);border-color:var(--primary)}
    .photos{display:flex;gap:6px;flex-wrap:wrap}
    .thumb{width:64px;height:64px;border:1px solid var(--border);border-radius:8px;overflow:hidden;background:#0002;display:inline-flex;align-items:center;justify-content:center;position:relative}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .thumb .x{position:absolute;top:2px;right:2px}
    .table{width:100%;border-collapse:collapse;background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .table th,.table td{padding:10px;border-bottom:1px solid var(--border)}
    .table th{text-align:left;color:var(--muted);font-weight:600;background:color-mix(in srgb, var(--card) 70%, var(--panel))}
    .table tr:hover td{background:color-mix(in srgb, var(--primary) 8%, transparent)}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
    .modal.open{display:flex}
    .dialog{background:var(--panel);border:1px solid var(--border);border-radius:14px;min-width:320px;max-width:860px;width:100%;box-shadow:var(--shadow)}
    .dialog .hd{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border);font-weight:700}
    .dialog .bd{padding:14px;display:grid;gap:10px}
    .dialog .ft{display:flex;justify-content:flex-end;gap:8px;padding:12px 14px;border-top:1px solid var(--border)}
    .field{display:grid;gap:6px}
    .field input,.field textarea,.field select{border:1px solid var(--border);background:var(--card);padding:8px 10px;border-radius:10px;outline:none}
    .field textarea{min-height:80px;resize:vertical}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:var(--card)}
    .counter{font-size:12px;color:var(--muted)}
    .hint{color:var(--muted);font-size:12px}
    .drop-hint{border:1px dashed var(--border);border-radius:10px;padding:8px;text-align:center;color:var(--muted)}

    html, body { overflow-x: hidden; }
    .main { min-width: 0; }
    @media (max-width: 960px){
      .grid{ grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); }
    }
    @media (max-width: 720px){
      .app{ grid-template-columns: 1fr; }
      .sidebar{
        position: fixed; left: 0; top: 0; bottom: 0;
        width: 88vw; max-width: 320px;
        transform: translateX(-110%);
        transition: transform .2s ease;
        z-index: 100; overflow:auto;
      }
      .sidebar.open{ transform: translateX(0); }
      .content{ padding: 12px; }
      .search{ max-width: none; min-width:0 }
    }
    .backdrop{ position: fixed; inset: 0; background: rgba(0,0,0,.45); display:none; z-index:90; }
    .backdrop.show{ display:block; }
  </style>
</head>
<body>
  <div class="app" id="app">
    <aside class="sidebar" id="sidebar">
      <div class="logo" title="Botiquín · Salud digital">
        <svg viewBox="0 0 64 64" aria-hidden="true">
          <defs><linearGradient id="g1" x1="0" x2="1" y1="0" y2="1">
            <stop offset="0%" stop-color="var(--primary)"/><stop offset="100%" stop-color="var(--accent)"/>
          </linearGradient></defs>
          <rect x="20" y="10" width="24" height="8" rx="2" fill="url(#g1)"/>
          <rect x="24" y="18" width="16" height="6" rx="2" fill="url(#g1)" opacity=".8"/>
          <rect x="16" y="24" width="32" height="30" rx="8" fill="none" stroke="url(#g1)" stroke-width="3"/>
          <rect x="20" y="32" width="24" height="16" rx="4" fill="url(#g1)" opacity=".25"/>
          <path d="M30 36h4v-4h4v4h4v4h-4v4h-4v-4h-4z" fill="url(#g1)"/>
        </svg>
        <span class="brand" data-ink>Botiquín</span>
      </div>
      <div class="folders-header">
        <strong data-ink>Carpetas</strong>
        <div><button class="btn" id="btnNewFolder" type="button" title="Nueva carpeta">＋</button></div>
      </div>
      <div class="folder-list" id="folderList" aria-label="Lista de carpetas"></div>
      <div class="hint" style="margin-top:10px" data-ink>Arrastra medicamentos a una carpeta para moverlos.</div>
      <hr style="border-color:var(--border);margin:14px 0"/>
      <div class="folders-header">
        <strong data-ink>Papelera</strong>
        <div class="folder-actions">
          <button class="btn" id="btnTrash" type="button">Ver</button>
          <button class="btn danger" id="btnEmptyTrash" type="button">Vaciar</button>
        </div>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <button class="btn" id="btnMenu" type="button" aria-label="Abrir menú">☰</button>

        <div class="pill" title="Selector de vista">
          <select id="viewSelect">
            <option value="cards">Vista cuadrícula</option>
            <option value="list">Vista tarjetas alargadas</option>
            <option value="table">Vista tabla</option>
          </select>
        </div>
        <div class="pill" title="Ordenación">
          <select id="sortSelect">
            <option value="name">Por nombre</option>
            <option value="nextDose">Por próxima toma</option>
            <option value="person">Por persona</option>
            <option value="updated">Más recientes</option>
          </select>
        </div>
        <div class="search" title="Buscar por nombre, posología o persona (tiempo real)">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--muted)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
          <input id="searchInput" placeholder="Buscar… (nombre, posología o persona)" />
        </div>
        <div class="toolbar">
          <div class="group">
            <button class="btn" id="btnSelectMode" type="button" title="Modo selección (mueve o elimina varios)">Seleccionar</button>
            <button class="btn danger" id="btnDeleteSelected" type="button" title="Eliminar seleccionados" disabled>Eliminar seleccionados</button>
            <span class="counter" id="selectedCount">0 seleccionados</span>
          </div>
          <div class="group">
            <button class="btn" id="btnUndo" type="button" title="Deshacer (Ctrl+Z)">↶</button>
            <button class="btn" id="btnRedo" type="button" title="Rehacer (Ctrl+Y / Ctrl+Shift+Z)">↷</button>
          </div>
          <div class="group">
            <button class="btn primary" id="btnNewMed" type="button" title="Nuevo medicamento">+ Medicamento</button>
            <button class="btn" id="btnImport" type="button" title="Importar JSON">Importar</button>
            <button class="btn" id="btnExport" type="button" title="Exportar JSON">Exportar</button>
          </div>
          <div class="group">
            <button class="btn" id="btnNotify" type="button" title="Activar recordatorios (notificaciones del navegador)">🔔</button>
            <button class="btn" id="btnTheme" type="button" title="Cambiar tema">🎨</button>
          </div>
        </div>
      </div>

      <div class="content">
        <!-- HERO con ilustración -->
        <section class="hero" aria-label="Cabecera visual">
          <h1 data-ink>Tu botiquín, organizado</h1>
          <p data-ink>Guarda medicamentos por carpetas, añade fotos, planifica tomas y recibe recordatorios.</p>
          <svg viewBox="0 0 220 120" aria-hidden="true">
            <defs><linearGradient id="p1" x1="0" x2="1"><stop offset="0" stop-color="var(--primary)"/><stop offset="1" stop-color="var(--accent)"/></linearGradient></defs>
            <g opacity="0.9">
              <rect x="120" y="10" width="56" height="20" rx="4" fill="url(#p1)"/>
              <rect x="126" y="28" width="44" height="10" rx="3" fill="url(#p1)" opacity="0.8"/>
              <rect x="110" y="40" width="76" height="60" rx="14" fill="none" stroke="url(#p1)" stroke-width="4"/>
              <rect x="120" y="56" width="56" height="26" rx="8" fill="url(#p1)" opacity="0.16"/>
              <g transform="translate(18,55) rotate(-18)"><rect x="0" y="0" width="70" height="24" rx="12" fill="url(#p1)"/><rect x="0" y="0" width="35" height="24" rx="12" fill="var(--card)"/></g>
              <g transform="translate(34,78) rotate(12)"><rect x="0" y="0" width="70" height="24" rx="12" fill="url(#p1)"/><rect x="35" y="0" width="35" height="24" rx="12" fill="var(--card)"/></g>
            </g>
          </svg>
        </section>

        <div id="breadcrumb" class="hint" style="margin:0 0 10px 2px" data-ink></div>
        <div id="cardsView" class="grid" aria-live="polite"></div>
        <div id="listView" class="list" style="display:none"></div>
        <div id="tableView" style="display:none"></div>
      </div>
    </main>
  </div>

  <!-- Modales -->
  <div class="modal" id="medModal" role="dialog" aria-modal="true">
    <div class="dialog">
      <div class="hd">Editar medicamento <button class="btn" id="closeMedModal" type="button">✕</button></div>
      <div class="bd">
        <div class="field"><label>Nombre</label><input id="medName" placeholder="Ej. Amoxicilina 500 mg"/></div>
        <div class="field"><label>Descripción</label><textarea id="medDesc" placeholder="Breve descripción (síntomas, notas)"></textarea></div>
        <div class="field"><label>Frecuencia / Posología</label><input id="medDose" placeholder="Ej. Cada 8h durante 5 días"/></div>
        <div class="field"><label>Persona</label><input id="medPerson" placeholder="Ej. Laura, Bebé"/></div>
        <div class="field"><label>Carpeta</label><select id="medFolder"></select></div>
        <div class="field"><label>Etiquetas</label>
          <div class="row">
            <label class="pill"><input type="checkbox" id="tagUrgente"> Urgente</label>
            <label class="pill"><input type="checkbox" id="tagCronico"> Crónico</label>
            <label class="pill"><input type="checkbox" id="tagPrueba"> En prueba</label>
            <label class="pill"><input type="checkbox" id="tagPRN"> Cuando sea necesario</label>
          </div>
        </div>
        <div class="field"><label>Próxima toma</label>
          <div class="row">
            <input type="datetime-local" id="medNext" />
            <span class="hint">(opcional, para recordatorios)</span>
          </div>
        </div>

        <!-- CALCULADORA DE POSOLOGÍA -->
        <div class="field">
          <label>Calculadora de posología (edad/peso)</label>
          <div class="row" style="gap:6px">
            <input id="calcPeso" type="number" min="0" step="0.1" placeholder="Peso (kg)" style="max-width:120px">
            <input id="calcEdad" type="number" min="0" step="1" placeholder="Edad (años)" style="max-width:120px">
            <input id="calcMgKg" type="number" min="0" step="0.1" placeholder="Dosis (mg/kg)" style="max-width:140px">
            <input id="calcIntervalo" type="number" min="1" step="1" placeholder="Intervalo (h)" style="max-width:140px">
            <input id="calcMax" type="number" min="0" step="1" placeholder="Máx por toma (mg)" style="max-width:160px">
          </div>
          <div class="row" style="gap:6px">
            <input id="calcConc" type="number" min="0" step="0.1" placeholder="Concentración (mg/ml)" style="max-width:160px">
            <input id="calcComp" type="number" min="0" step="1" placeholder="Comprimido (mg/unid)" style="max-width:180px">
            <button class="btn" id="btnCalc" type="button">Calcular</button>
            <button class="btn primary" id="btnAplicarCalc" type="button" title="Enviar al campo Posología">Aplicar a posología</button>
          </div>
          <div id="calcResultado" class="hint"></div>
          <div class="hint">⚠️ Orientativo. Para decisiones médicas, consulta siempre a un profesional sanitario.</div>
        </div>

        <div class="field"><label>Fotografías</label>
          <input type="file" id="medPhotos" accept="image/*" multiple />
          <div class="hint">Se redimensionan automáticamente (máx 1200px) para ahorrar espacio.</div>
          <div class="photos" id="medPhotosPreview"></div>
          <div class="drop-hint">También puedes arrastrar y soltar imágenes aquí o sobre una tarjeta para adjuntarlas.</div>
        </div>
      </div>
      <div class="ft">
        <button class="btn danger" id="btnArchive" type="button">Finalizar y archivar</button>
        <button class="btn" id="btnCancelEdit" type="button">Cancelar</button>
        <button class="btn primary" id="btnSaveMed" type="button">Guardar</button>
      </div>
    </div>
  </div>

  <div class="modal" id="folderModal" role="dialog" aria-modal="true">
    <div class="dialog">
      <div class="hd">Carpeta <button class="btn" id="closeFolderModal" type="button">✕</button></div>
      <div class="bd"><div class="field"><label>Nombre</label><input id="folderName" placeholder="Ej. Antibióticos"/></div></div>
      <div class="ft">
        <button class="btn" id="btnCancelFolder" type="button">Cancelar</button>
        <button class="btn primary" id="btnSaveFolder" type="button">Guardar</button>
      </div>
    </div>
  </div>

  <div class="modal" id="trashModal" role="dialog" aria-modal="true">
    <div class="dialog">
      <div class="hd">Papelera <button class="btn" id="closeTrashModal" type="button">✕</button></div>
      <div class="bd" id="trashBody"></div>
      <div class="ft">
        <button class="btn danger" id="btnPurgeAll" type="button">Eliminar definitivamente</button>
        <button class="btn" id="btnCloseTrash" type="button">Cerrar</button>
      </div>
    </div>
  </div>

  <input type="file" id="fileInput" accept="application/json" style="display:none"/>
  <div id="backdrop" class="backdrop"></div>

  <script>
  // ===== Helpers =====
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const uid = (p='id') => p + '_' + Math.random().toString(36).slice(2,9);
  const confirmBox = msg => window.confirm(msg);

  // ===== Estado y persistencia =====
  const STORAGE_KEY='botiquin.v2';
  let state={
    folders:[{id:'all',name:'Todos',order:0}],
    meds:[],
    trash:{meds:[],folders:[]},
    view:'cards', sort:'name', theme:'dark', activeFolder:'all',
    selectMode:false, selected:new Set(), lastSaved:Date.now(),
    collapsed:{}
  };
  const history={undo:[],redo:[],push(){this.undo.push(JSON.stringify(state)); if(this.undo.length>50) this.undo.shift(); this.redo.length=0;},
    canUndo(){return this.undo.length>0}, canRedo(){return this.redo.length>0},
    doUndo(){if(!this.canUndo())return; this.redo.push(JSON.stringify(state)); state=JSON.parse(this.undo.pop()); state.selected=new Set(state.selected||[]); renderAll(); save();},
    doRedo(){if(!this.canRedo())return; this.undo.push(JSON.stringify(state)); state=JSON.parse(this.redo.pop()); state.selected=new Set(state.selected||[]); renderAll(); save();}
  };
  function load(){const raw=localStorage.getItem(STORAGE_KEY); if(raw){try{state=JSON.parse(raw); state.selected=new Set(state.selected||[]);}catch{}} applyTheme(state.theme);}
  function save(){state.lastSaved=Date.now(); localStorage.setItem(STORAGE_KEY, JSON.stringify({...state, selected:[...state.selected]}));}

  // ===== Temas =====
  const THEMES=['dark','light','olive','aqua','amethyst','solar'];
  function applyTheme(name){document.body.classList.remove(...THEMES.map(t=>'theme-'+t)); if(name!=='dark') document.body.classList.add('theme-'+name); state.theme=name||'dark'; const m=document.querySelector('meta[name="theme-color"]'); if(m) m.setAttribute('content', getComputedStyle(document.documentElement).getPropertyValue('--panel').trim()); save();}

  // ===== Carpetas =====
  function addFolder(name){history.push(); const id=uid('fld'); state.folders.push({id,name,order:Date.now()}); save(); renderFolders(); renderAll(); return id;}
  function updateFolder(id,name){history.push(); const f=state.folders.find(x=>x.id===id); if(f){f.name=name; save(); renderFolders(); renderAll();}}
  function deleteFolder(id){if(id==='all') return; if(!confirmBox('¿Eliminar carpeta y mover medicamentos a "Todos"?')) return; history.push(); state.trash.folders.push(state.folders.find(f=>f.id===id)); state.folders=state.folders.filter(f=>f.id!==id); state.meds.forEach(m=>{if(m.folderId===id) m.folderId='all';}); save(); renderFolders(); renderAll();}
  let draggingFolderId=null;
  function renderFolders(){const list=$('#folderList'); list.innerHTML=''; state.folders.sort((a,b)=> (a.id==='all')?-1:(b.id==='all')?1:a.order-b.order);
    state.folders.forEach(f=>{const el=document.createElement('div'); el.className='folder'+(f.id===state.activeFolder?' active':''); el.draggable=f.id!=='all'; el.dataset.id=f.id;
      el.innerHTML=`<span class="folder-name" data-ink>${f.name}</span><div class="folder-actions">${f.id!=='all'?'<button class="btn btnFolderRename" type="button" title="Renombrar">✎</button>':''}${f.id!=='all'?'<button class="btn btnFolderDelete" type="button" title="Eliminar">🗑</button>':''}</div>`;
      el.addEventListener('click',e=>{if(e.target.closest('.btn')) return; state.activeFolder=f.id; renderAll(); save();});
      if(f.id!=='all'){el.addEventListener('dragstart',()=>{draggingFolderId=f.id; el.style.opacity=.5;}); el.addEventListener('dragend',()=>{draggingFolderId=null; el.style.opacity=1;});
        el.addEventListener('dragover',e=>{e.preventDefault(); el.style.outline='2px dashed var(--primary)';});
        el.addEventListener('dragleave',()=>{el.style.outline='';});
        el.addEventListener('drop',()=>{el.style.outline=''; history.push(); const src=state.folders.find(x=>x.id===draggingFolderId); const dst=state.folders.find(x=>x.id===f.id); if(src&&dst&&src.id!==dst.id){src.order=dst.order-1; save(); renderFolders();}});}
      el.addEventListener('dragover',e=>e.preventDefault());
      el.addEventListener('drop',e=>{const ids=(e.dataTransfer?.getData('text/med-ids')||'').split(',').filter(Boolean); if(!ids.length) return; history.push(); ids.forEach(id=>{const m=state.meds.find(x=>x.id===id); if(m) m.folderId=f.id;}); save(); renderAll();});
      list.appendChild(el);
    });
  }

  // ===== Medicamentos =====
  let editingMedId=null;
  function newMed(){editingMedId=null; openMedModal();}
  function editMed(id){editingMedId=id; openMedModal(id);}
  function duplicateMed(id){const src=state.meds.find(m=>m.id===id); if(!src) return; history.push(); const copy={...src,id:uid('med'),name:src.name+' (copia)',created:Date.now(),updated:Date.now()}; state.meds.push(copy); save(); renderAll();}
  function removeMed(id){history.push(); const m=state.meds.find(x=>x.id===id); if(!m) return; state.trash.meds.push(m); state.meds=state.meds.filter(x=>x.id!==id); save(); renderAll();}
  function removeSelected(){if(!state.selected.size) return; if(!confirmBox(`¿Eliminar ${state.selected.size} seleccionados?`)) return; history.push(); const ids=[...state.selected]; ids.forEach(id=>{const m=state.meds.find(x=>x.id===id); if(m) state.trash.meds.push(m);}); state.meds=state.meds.filter(m=>!state.selected.has(m.id)); state.selected.clear(); save(); renderAll();}
  function setArchived(id,flag=true){history.push(); const m=state.meds.find(x=>x.id===id); if(m){m.archived=!!flag; m.updated=Date.now(); save(); renderAll();}}
  function attachCardDrag(el,id){el.draggable=true;
    el.addEventListener('dragstart',e=>{const ids=state.selectMode&&state.selected.size?[...state.selected]:[id]; e.dataTransfer.setData('text/med-ids',ids.join(',')); el.classList.add('dragging');});
    el.addEventListener('dragend',()=>el.classList.remove('dragging'));
    el.addEventListener('dragover',e=>{if([...e.dataTransfer.items].some(i=>i.kind==='file')){e.preventDefault(); el.style.outline='2px dashed var(--primary)';}});
    el.addEventListener('dragleave',()=>el.style.outline='');
    el.addEventListener('drop',async e=>{if(![...e.dataTransfer.items].some(i=>i.kind==='file')) return; e.preventDefault(); el.style.outline=''; const files=[...e.dataTransfer.files].filter(f=>f.type.startsWith('image/')); if(!files.length) return; history.push(); const m=state.meds.find(x=>x.id===id); if(!m) return; m.photos=m.photos||[]; for(const f of files){const data=await fileToResizedDataURL(f,1200); m.photos.push(data);} m.updated=Date.now(); save(); renderAll();});
  }

  // ===== Render =====
  function currentMeds(){let meds=state.meds.filter(m=>!m.archived); if(state.activeFolder!=='all') meds=meds.filter(m=>m.folderId===state.activeFolder); const q=$('#searchInput').value.trim().toLowerCase(); if(q) meds=meds.filter(m=>(m.name+' '+(m.dose||'')+' '+(m.person||'')).toLowerCase().includes(q)); meds.sort((a,b)=>{switch(state.sort){case'person':return (a.person||'').localeCompare(b.person||'')||a.name.localeCompare(b.name);case'updated':return (b.updated||0)-(a.updated||0);case'nextDose':return (a.nextDose||Infinity)-(b.nextDose||Infinity);default:return a.name.localeCompare(b.name);}}); return meds;}
  function renderAll(){
    renderFolders(); renderBreadcrumb();
    const v = state.view || 'cards';
    $('#cardsView').style.display = (v==='cards') ? 'grid' : 'none';
    $('#listView').style.display  = (v==='list')  ? 'flex' : 'none';
    $('#tableView').style.display = (v==='table') ? 'block' : 'none';
    if(v==='cards') renderCards();
    else if(v==='list') renderList();
    else renderTable();
    updateSelectionUI(); updateUndoRedoUI(); populateFolderSelect();
  }
  function renderBreadcrumb(){const f=state.folders.find(x=>x.id===state.activeFolder); $('#breadcrumb').textContent=`Carpeta: ${f?f.name:'(desconocida)'} • ${currentMeds().length} elementos`;}

  function tagBadges(m){return `
    <span class="tag">${m.dose||'—'}</span>
    ${m.tags?.includes('urgente')?'<span class="tag" style="border-color:var(--danger);color:var(--danger)">Urgente</span>':''}
    ${m.tags?.includes('cronico')?'<span class="tag" style="border-color:var(--warning);color:var(--warning)">Crónico</span>':''}
    ${m.tags?.includes('prueba')?'<span class="tag" style="border-color:var(--accent);color:var(--accent)">En prueba</span>':''}
    ${m.tags?.includes('prn')?'<span class="tag" style="border-color:var(--success);color:var(--success)">Cuando sea necesario</span>':''}
    ${m.nextDose?'<span class="tag">⏰ '+new Date(m.nextDose).toLocaleString()+'</span>':''}`;}

  function actionButtons(id){return `
      <button class="btn" data-edit="${id}" type="button">Editar</button>
      <button class="btn" data-copy="${id}" type="button">Copiar</button>
      <button class="btn" data-dup="${id}" type="button">Duplicar</button>
      <button class="btn danger" data-del="${id}" type="button">Eliminar</button>`;}

  function renderCards(){const wrap=$('#cardsView'); wrap.innerHTML=''; currentMeds().forEach(m=>{const card=document.createElement('div'); const collapsed=!!state.collapsed[m.id]; card.className='card'+(state.selectMode?' select-mode':'')+(collapsed?' collapsed':''); card.dataset.id=m.id; attachCardDrag(card,m.id);
      card.addEventListener('dblclick',()=>{state.collapsed[m.id]=!state.collapsed[m.id]; save(); renderAll();});
      const checked=state.selected.has(m.id); const photos=(m.photos||[]).slice(0,4).map(src=>`<span class="thumb"><img src="${src}" alt="foto"/></span>`).join(''); card.innerHTML=`
        <div class="card-header">
          <label class="checkbox"><input type="checkbox" ${checked?'checked':''} data-sel="${m.id}"></label>
          <div class="title" title="${m.name}" data-ink>${m.name}</div>
          <div class="person" title="Persona asignada">${m.person||'—'}</div>
        </div>
        ${photos?'<div class="photos">'+photos+'</div>':''}
        <div class="desc" data-ink>${m.desc||'—'}</div>
        <div class="meta" data-ink>${tagBadges(m)}</div>
        <div class="row">
          <select data-move="${m.id}" title="Mover a carpeta">
            ${state.folders.map(f=>`<option value="${f.id}" ${m.folderId===f.id?'selected':''}>${f.name}</option>`).join('')}
          </select>
          <span class="spacer"></span>
          ${actionButtons(m.id)}
        </div>`; wrap.appendChild(card);});}

  function renderList(){const wrap=$('#listView'); wrap.innerHTML=''; currentMeds().forEach(m=>{const card=document.createElement('div'); const collapsed=!!state.collapsed[m.id]; card.className='card'+(state.selectMode?' select-mode':'')+(collapsed?' collapsed':''); card.dataset.id=m.id; attachCardDrag(card,m.id);
      card.addEventListener('dblclick',()=>{state.collapsed[m.id]=!state.collapsed[m.id]; save(); renderAll();});
      const checked=state.selected.has(m.id); card.innerHTML=`
        <div>
          <div class="card-header">
            <label class="checkbox"><input type="checkbox" ${checked?'checked':''} data-sel="${m.id}"></label>
            <div class="title" title="${m.name}" data-ink>${m.name}</div>
            <div class="person">${m.person||'—'}</div>
          </div>
          <div class="desc" data-ink>${m.desc||'—'}</div>
          <div class="meta" data-ink>${tagBadges(m)}</div>
        </div>
        <div class="row" style="justify-content:flex-end">${actionButtons(m.id)}</div>`; wrap.appendChild(card);});}

  function renderTable(){const meds=currentMeds(); const wrap=$('#tableView'); const rows=meds.map(m=>`<tr data-id="${m.id}">
      <td><label class="checkbox ${state.selectMode?'':'" style=\\"display:none\\"'}"><input type="checkbox" ${state.selected.has(m.id)?'checked':''} data-sel="${m.id}"></label></td>
      <td>${m.name}</td><td>${m.dose||'—'}</td><td>${m.person||'—'}</td><td>${m.desc||'—'}</td><td>${m.nextDose?new Date(m.nextDose).toLocaleString():'—'}</td>
      <td><button class="btn" data-edit="${m.id}" type="button">Editar</button> <button class="btn" data-copy="${m.id}" type="button">Copiar</button> <button class="btn" data-dup="${m.id}" type="button">Duplicar</button> <button class="btn danger" data-del="${m.id}" type="button">Eliminar</button></td>
    </tr>`).join(''); wrap.innerHTML=`<table class="table"><thead><tr><th></th><th>Nombre</th><th>Frecuencia</th><th>Persona</th><th>Descripción</th><th>Próxima toma</th><th>Acciones</th></tr></thead><tbody>${rows}</tbody></table>`;}

  function updateSelectionUI(){document.body.classList.toggle('select-mode',state.selectMode); $('#btnDeleteSelected').disabled=state.selected.size===0; $('#selectedCount').textContent=`${state.selected.size} seleccionados`; $('#btnSelectMode').textContent=state.selectMode?'Salir selección':'Seleccionar';}
  function updateUndoRedoUI(){$('#btnUndo').disabled=!history.canUndo(); $('#btnRedo').disabled=!history.canRedo();}

  // ===== Folder Modal =====
  let editingFolderId=null;
  function openFolderModal(id){ editingFolderId=id||null; const input=$('#folderName'); input.value=id?(state.folders.find(f=>f.id===id)?.name||''):''; $('#folderModal').classList.add('open'); setTimeout(()=> input.focus(), 30); }
  function closeFolderModal(){ $('#folderModal').classList.remove('open'); editingFolderId=null; }
  function saveFolderFromModal(){ const name=$('#folderName').value.trim(); if(!name) return alert('Pon un nombre para la carpeta'); if(editingFolderId){updateFolder(editingFolderId,name);} else {const newId=addFolder(name); state.activeFolder=newId;} save(); renderAll(); closeFolderModal(); }

  // ===== Eventos =====
  function bindEvents(){
    $('#btnTheme').addEventListener('click',()=>{const i=THEMES.indexOf(state.theme); const next=THEMES[(i+1)%THEMES.length]; applyTheme(next);});
    $('#btnNewMed').addEventListener('click',newMed);
    $('#btnNewFolder').addEventListener('click',()=>openFolderModal());
    $('#btnDeleteSelected').addEventListener('click',removeSelected);
    $('#btnSelectMode').addEventListener('click',()=>{state.selectMode=!state.selectMode; if(!state.selectMode) state.selected.clear(); renderAll(); save();});
    $('#btnUndo').addEventListener('click',()=>history.doUndo());
    $('#btnRedo').addEventListener('click',()=>history.doRedo());
    $('#btnExport').addEventListener('click',doExport);
    $('#btnImport').addEventListener('click',()=>$('#fileInput').click());
    $('#fileInput').addEventListener('change',handleImport);
    $('#btnNotify').addEventListener('click',enableNotifications);
    $('#btnTrash').addEventListener('click',openTrashModal);
    $('#btnEmptyTrash').addEventListener('click',()=>{if(confirmBox('¿Vaciar por completo la papelera?')){history.push(); state.trash.meds=[]; state.trash.folders=[]; save();}});
    $('#searchInput').addEventListener('input',()=>renderAll());

    // sincroniza selectores con estado
    $('#viewSelect').value=state.view||'cards';
    $('#viewSelect').addEventListener('change',e=>{state.view=e.target.value; save(); renderAll();});
    $('#sortSelect').value=state.sort||'name';
    $('#sortSelect').addEventListener('change',e=>{state.sort=e.target.value; save(); renderAll();});

    // Carpeta modal
    document.addEventListener('click',e=>{
      if(e.target.id==='closeFolderModal' || e.target.id==='btnCancelFolder') closeFolderModal();
      if(e.target.id==='btnSaveFolder') saveFolderFromModal();
    });
    $('#folderModal').addEventListener('keydown',e=>{
      if(e.key==='Enter'){ e.preventDefault(); saveFolderFromModal(); }
      if(e.key==='Escape'){ e.preventDefault(); closeFolderModal(); }
    });

    document.addEventListener('keydown',e=>{
      if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='z'){e.preventDefault(); if(e.shiftKey)history.doRedo(); else history.doUndo();}
      if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='y'){e.preventDefault(); history.doRedo();}
      if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='a'){if(state.selectMode){e.preventDefault(); currentMeds().forEach(m=>state.selected.add(m.id)); renderAll();}}
      if(e.key==='Escape'){ if(state.selectMode){state.selected.clear(); renderAll();} closeSidebar(); }
    });

    document.body.addEventListener('change',e=>{
      const selId = e.target.getAttribute('data-sel');
      if(selId){ if(e.target.checked) state.selected.add(selId); else state.selected.delete(selId); updateSelectionUI(); save(); return; }
      const moveId = e.target.getAttribute('data-move');
      if(moveId){ history.push(); const m=state.meds.find(x=>x.id===moveId); if(m){m.folderId=e.target.value; m.updated=Date.now(); save();} }
    });

    document.body.addEventListener('click',e=>{
      const editBtn = e.target.closest('button[data-edit]'); if(editBtn){ editMed(editBtn.getAttribute('data-edit')); return; }
      const copyBtn = e.target.closest('button[data-copy]'); if(copyBtn){ copyMed(copyBtn.getAttribute('data-copy')); return; }
      const dupBtn = e.target.closest('button[data-dup]'); if(dupBtn){ duplicateMed(dupBtn.getAttribute('data-dup')); return; }
      const delBtn = e.target.closest('button[data-del]'); if(delBtn){ if(confirmBox('¿Eliminar este medicamento?')) removeMed(delBtn.getAttribute('data-del')); return; }

      const rn=e.target.closest('.btnFolderRename'); if(rn){const id=rn.closest('.folder').dataset.id; openFolderModal(id); return;}
      const dl=e.target.closest('.btnFolderDelete'); if(dl){const id=dl.closest('.folder').dataset.id; if(confirmBox('¿Eliminar carpeta?')) deleteFolder(id); return;}
    });

    // drop a carpeta activa
    $('#cardsView').addEventListener('dragover',e=>e.preventDefault());
    $('#cardsView').addEventListener('drop',e=>{const ids=(e.dataTransfer?.getData('text/med-ids')||'').split(',').filter(Boolean); if(!ids.length) return; history.push(); ids.forEach(id=>{const m=state.meds.find(x=>x.id===id); if(m) m.folderId=state.activeFolder;}); save(); renderAll();});

    // drag & drop de fotos
    const modal=$('#medModal');
    modal.addEventListener('dragover',e=>{if(e.target.closest('#medPhotosPreview')) e.preventDefault();});
    modal.addEventListener('drop',async e=>{if(!e.target.closest('#medPhotosPreview')) return; e.preventDefault(); const files=[...e.dataTransfer.files].filter(f=>f.type.startsWith('image/') ); await previewPhotos(files);});

    // Drawer móvil
    $('#btnMenu')?.addEventListener('click',()=>{ $('#sidebar').classList.add('open'); $('#backdrop').classList.add('show'); });
    $('#backdrop')?.addEventListener('click',closeSidebar);

    // Calculadora
    $('#btnCalc').addEventListener('click',calcPosologia);
    $('#btnAplicarCalc').addEventListener('click',()=>{
      const r = $('#calcResultado')?.dataset.texto || '';
      if(!r) return;
      const prev = ($('#medDose').value||'').trim();
      $('#medDose').value = prev ? (prev + ' • ' + r) : r;
    });
  }
  function closeSidebar(){ $('#sidebar').classList.remove('open'); $('#backdrop').classList.remove('show'); }

  // Portapapeles
  async function copyMed(id){const m=state.meds.find(x=>x.id===id); if(!m) return; const txt=`${m.name}\n${m.dose||''}\n${m.person||''}\n${m.desc||''}`.trim(); try{await navigator.clipboard.writeText(txt); toast('Copiado en el portapapeles');}catch{alert('No se pudo copiar');}}
  function toast(msg){const t=document.createElement('div'); t.textContent=msg; Object.assign(t.style,{position:'fixed',bottom:'16px',right:'16px',background:'var(--card)',border:'1px solid var(--border)',padding:'10px 12px',borderRadius:'10px',boxShadow:'var(--shadow)',zIndex:9999,color:'var(--text)'}); document.body.appendChild(t); setTimeout(()=>t.remove(),1800);}

  // Fotos
  let tempPhotos=[]; let existingPhotos=[];
  async function previewPhotos(files){for(const f of files){if(!f.type.startsWith('image/')) continue; const data=await fileToResizedDataURL(f,1200); tempPhotos.push(data);} paintPhotosPreview();}
  function paintPhotosPreview(){const box=$('#medPhotosPreview'); box.innerHTML='';
    existingPhotos.forEach((src,i)=>{const d=document.createElement('div'); d.className='thumb'; d.innerHTML=`<img src="${src}" alt="foto"/><button class="btn danger x" data-delphoto-ex="${i}" type="button">✕</button>`; box.appendChild(d);});
    tempPhotos.forEach((src,i)=>{const d=document.createElement('div'); d.className='thumb'; d.innerHTML=`<img src="${src}" alt="foto"/><button class="btn danger x" data-delphoto-tmp="${i}" type="button">✕</button>`; box.appendChild(d);});
    box.querySelectorAll('[data-delphoto-ex]').forEach(b=>b.addEventListener('click',()=>{const i=+b.getAttribute('data-delphoto-ex'); existingPhotos.splice(i,1); paintPhotosPreview();}));
    box.querySelectorAll('[data-delphoto-tmp]').forEach(b=>b.addEventListener('click',()=>{const i=+b.getAttribute('data-delphoto-tmp'); tempPhotos.splice(i,1); paintPhotosPreview();}));
  }
  async function fileToResizedDataURL(file,maxSide=1200){const img=await new Promise(res=>{const r=new FileReader(); r.onload=()=>{const i=new Image(); i.onload=()=>res(i); i.src=r.result;}; r.readAsDataURL(file);}); const scale=Math.min(1,maxSide/Math.max(img.width,img.height)); const w=Math.round(img.width*scale), h=Math.round(img.height*scale); const c=document.createElement('canvas'); c.width=w; c.height=h; const ctx=c.getContext('2d'); ctx.fillStyle='#fff'; ctx.fillRect(0,0,w,h); ctx.drawImage(img,0,0,w,h); return c.toDataURL('image/jpeg',0.85);}

  // Calculadora de posología (simple)
  function calcPosologia(){
    const peso=parseFloat($('#calcPeso').value||'0');
    const edad=parseFloat($('#calcEdad').value||'0');
    const mgkg=parseFloat($('#calcMgKg').value||'0');
    const intervalo=parseFloat($('#calcIntervalo').value||'0');
    const max=parseFloat($('#calcMax').value||'0');
    const conc=parseFloat($('#calcConc').value||'0'); // mg/ml
    const comp=parseFloat($('#calcComp').value||'0'); // mg/unidad

    if(!(peso>0 && mgkg>0 && intervalo>0)){
      $('#calcResultado').textContent='Completa al menos: peso, mg/kg e intervalo.';
      $('#calcResultado').dataset.texto='';
      return;
    }
    let dosis = peso * mgkg; // mg por toma
    if(max>0) dosis = Math.min(dosis, max);
    function roundTo(x, step){ if(!step) return Math.round(x); return Math.round(x/step)*step; }

    let texto = `${roundTo(dosis,5)} mg cada ${intervalo} h`;
    if(conc>0){
      const ml = dosis/conc;
      texto += ` (${(Math.round(ml*10)/10)} ml)`;
    }
    if(comp>0){
      const tabs = dosis/comp;
      const tabsR = Math.round(tabs*2)/2; // a medios comprimidos
      texto += ` • ${tabsR} comp.`;
    }
    if(edad>0) texto += ` (edad: ${edad} años)`;

    $('#calcResultado').textContent=texto;
    $('#calcResultado').dataset.texto=texto;
  }

  // Modales de medicamentos
  function openMedModal(id){
    tempPhotos=[];
    const m=id?state.meds.find(x=>x.id===id):{name:'',desc:'',dose:'',person:'',folderId:state.activeFolder,tags:[],nextDose:null,photos:[]};
    existingPhotos = (m.photos||[]).slice();
    $('#medName').value=m.name||'';
    $('#medDesc').value=m.desc||'';
    $('#medDose').value=m.dose||'';
    $('#medPerson').value=m.person||'';
    $('#medNext').value=m.nextDose?new Date(m.nextDose).toISOString().slice(0,16):'';
    populateFolderSelect(); $('#medFolder').value=m.folderId||state.activeFolder;
    $('#tagUrgente').checked=m.tags?.includes('urgente');
    $('#tagCronico').checked=m.tags?.includes('cronico');
    $('#tagPrueba').checked=m.tags?.includes('prueba');
    $('#tagPRN').checked=m.tags?.includes('prn');
    paintPhotosPreview();
    $('#medModal').classList.add('open');
  }
  function closeMedModal(){$('#medModal').classList.remove('open'); tempPhotos=[]; existingPhotos=[]; $('#calcResultado').textContent=''; $('#calcResultado').dataset.texto='';}
  function populateFolderSelect(){const sel=$('#medFolder'); if(!sel) return; sel.innerHTML=state.folders.map(f=>`<option value="${f.id}">${f.name}</option>`).join('');}
  document.addEventListener('click',e=>{if(e.target.id==='closeMedModal'||e.target.id==='btnCancelEdit') closeMedModal();});
  document.addEventListener('click',e=>{
    if(e.target.id==='btnSaveMed' || e.target.id==='btnArchive'){
      const data={
        name:$('#medName').value.trim(),
        desc:$('#medDesc').value.trim(),
        dose:$('#medDose').value.trim(),
        person:$('#medPerson').value.trim(),
        folderId:$('#medFolder').value,
        tags:[ $('#tagUrgente').checked&&'urgente', $('#tagCronico').checked&&'cronico', $('#tagPrueba').checked&&'prueba', $('#tagPRN').checked&&'prn' ].filter(Boolean),
        nextDose:$('#medNext').value?new Date($('#medNext').value).getTime():null
      };
      if(!data.name) return alert('Pon un nombre de medicamento');
      const archivar = (e.target.id==='btnArchive');
      history.push();
      if(editingMedId){
        const m=state.meds.find(x=>x.id===editingMedId);
        m.photos = existingPhotos.concat(tempPhotos);
        Object.assign(m,data,{updated:Date.now(), archived: archivar ? true : m.archived});
      } else {
        state.meds.push({id:uid('med'),created:Date.now(),updated:Date.now(),archived:archivar,photos:existingPhotos.concat(tempPhotos),...data});
      }
      save(); closeMedModal(); renderAll(); scheduleCheck();
    }
  });

  // Papelera
  function openTrashModal(){const body=$('#trashBody'); body.innerHTML=''; const meds=state.trash.meds; if(!meds.length){body.innerHTML='<div class="hint" data-ink>La papelera está vacía</div>';} else {meds.forEach(m=>{const row=document.createElement('div'); row.className='row'; Object.assign(row.style,{alignItems:'center',justifyContent:'space-between',padding:'6px 0',borderBottom:'1px solid var(--border)'}); row.innerHTML=`<div><strong data-ink>${m.name}</strong><div class="hint" data-ink">${m.dose||''} · ${m.person||''}</div></div><div class="row"><button class="btn" data-restore="${m.id}" type="button">Restaurar</button><button class="btn danger" data-purge="${m.id}" type="button">Eliminar</button></div>`; body.appendChild(row);});} $('#trashModal').classList.add('open');}
  function closeTrashModal(){$('#trashModal').classList.remove('open');}
  document.body.addEventListener('click',e=>{
    const rid=e.target.closest('button[data-restore]'); if(rid){history.push(); const id=rid.getAttribute('data-restore'); const m=state.trash.meds.find(x=>x.id===id); if(m){state.meds.push(m); state.trash.meds=state.trash.meds.filter(x=>x.id!==id); save(); openTrashModal(); renderAll();} return;}
    const pid=e.target.closest('button[data-purge]'); if(pid){if(confirmBox('¿Eliminar definitivamente?')){history.push(); const id=pid.getAttribute('data-purge'); state.trash.meds=state.trash.meds.filter(x=>x.id!==id); save(); openTrashModal();}}
  });
  document.addEventListener('click',e=>{if(e.target.id==='closeTrashModal'||e.target.id==='btnCloseTrash') closeTrashModal();});

  // Importar/Exportar
  function doExport(){const data=JSON.stringify({...state,selected:[]},null,2); const url=URL.createObjectURL(new Blob([data],{type:'application/json'})); const a=document.createElement('a'); a.href=url; a.download='botiquin.json'; a.click(); URL.revokeObjectURL(url);}
  function handleImport(e){const file=e.target.files[0]; if(!file) return; const r=new FileReader(); r.onload=()=>{try{const data=JSON.parse(r.result); history.push(); state={...data,selected:new Set()}; applyTheme(state.theme||'dark'); save(); renderAll();}catch{alert('JSON no válido');}}; r.readAsText(file); e.target.value='';}

  // Recordatorios
  async function enableNotifications(){try{const res=await Notification.requestPermission(); if(res==='granted'){toast('Notificaciones activadas'); scheduleCheck();} else {alert('Permiso de notificaciones denegado');}}catch{alert('Este navegador no soporta notificaciones');}}
  let reminderTimer=null; function scheduleCheck(){if(reminderTimer) clearInterval(reminderTimer); reminderTimer=setInterval(checkReminders,30*1000);}
  function checkReminders(){const now=Date.now(); state.meds.forEach(m=>{if(m.nextDose && m.nextDose<=now && !m._fired){m._fired=true; notify(`Toca tomar: ${m.name}`, m.dose||'');}});}
  function notify(title,body){if('Notification' in window && Notification.permission==='granted'){new Notification(title,{body});} alert(`${title}\n${body}`);}

  // Inicialización
  function ensureDemo(){ if(state.meds.length===0){const ab=addFolder('Antibióticos'), an=addFolder('Analgésicos'), vt=addFolder('Vitaminas'); history.push(); state.meds.push(
      {id:uid('med'),name:'Amoxicilina 500 mg',desc:'Infección respiratoria. Tomar con comida. Vigilar diarrea.',dose:'Cada 8h durante 5 días',person:'Laura',folderId:ab,tags:['urgente'],photos:[],created:Date.now(),updated:Date.now()},
      {id:uid('med'),name:'Ibuprofeno 400 mg',desc:'Dolor moderado. Evitar si hay gastritis.',dose:'Cada 8h si dolor',person:'Padre',folderId:an,photos:[],created:Date.now(),updated:Date.now()},
      {id:uid('med'),name:'Vitamina D3 2000 UI',desc:'Suplemento diario.',dose:'1 al día',person:'Bebé',folderId:vt,tags:['cronico','prn'],photos:[],created:Date.now(),updated:Date.now()}
    ); save();}}
  function bindGlobalClicks(){document.addEventListener('click',e=>{if(!state.selectMode) return; const card=e.target.closest('.card'); if(card && !e.target.closest('button,select,.checkbox,input')){const id=card.dataset.id; if(state.selected.has(id)) state.selected.delete(id); else state.selected.add(id); updateSelectionUI(); save();}});}
  function init(){load(); bindEvents(); ensureDemo(); renderAll(); scheduleCheck(); bindGlobalClicks(); const obs=new MutationObserver(()=>{$$('#cardsView .card').forEach(c=>attachCardDrag(c,c.dataset.id)); $$('#listView .card').forEach(c=>attachCardDrag(c,c.dataset.id));}); obs.observe(document.body,{childList:true,subtree:true}); }
  init();
  </script>
</body>
</html>
