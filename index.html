<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<meta name="theme-color" content="#151925"/>
<title>BotiquÃ­n Â· Gestor de Medicamentos (PWA)</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect x='20' y='10' width='24' height='8' rx='2' fill='%235dd5c4'/%3E%3Crect x='24' y='18' width='16' height='6' rx='2' fill='%23a78bfa'/%3E%3Crect x='16' y='24' width='32' height='30' rx='8' fill='none' stroke='%235dd5c4' stroke-width='3'/%3E%3Crect x='20' y='32' width='24' height='16' rx='4' fill='%235dd5c4' opacity='.25'/%3E%3Cpath d='M30 36h4v-4h4v4h4v4h-4v4h-4v-4h-4z' fill='%23a78bfa'/%3E%3C/svg%3E" />
<link rel="manifest" id="inline-manifest">
<style>
  :root{--bg:#0f1115;--panel:#151925;--sidebar:#1b2030;--text:#e6e8ee;--muted:#a8afc1;--primary:#5dd5c4;--accent:#a78bfa;--danger:#ef4444;--warning:#f59e0b;--success:#22c55e;--border:#2a3042;--card:#171c2a;--shadow:0 10px 30px rgba(0,0,0,.35)}
  .theme-light{--bg:#f7f8fb;--panel:#ffffff;--sidebar:#eef1f7;--text:#12141a;--muted:#616c7f;--primary:#2563eb;--accent:#14b8a6;--danger:#dc2626;--warning:#d97706;--success:#16a34a;--border:#e6e9f2;--card:#ffffff;--shadow:0 8px 24px rgba(0,0,0,.08)}
  .theme-olive{--bg:#0c1110;--panel:#101614;--sidebar:#0e1312;--text:#e8efe9;--muted:#a0b3a7;--primary:#7cc39b;--accent:#e7b75f;--danger:#e57373;--warning:#e0a545;--success:#65c18c;--border:#1e2a25;--card:#0f1715}
  .theme-aqua{--bg:#071418;--panel:#0b1d24;--sidebar:#08161b;--text:#e3f6fb;--muted:#98c0cc;--primary:#29b6f6;--accent:#22d3ee;--danger:#ef5350;--warning:#ffd54f;--success:#26c6da;--border:#12303a;--card:#0b1f27}
  .theme-amethyst{--bg:#0f0d14;--panel:#151225;--sidebar:#120f1f;--text:#efe9fb;--muted:#b7a7e6;--primary:#8b5cf6;--accent:#06b6d4;--danger:#f43f5e;--warning:#f59e0b;--success:#22c55e;--border:#231b3f;--card:#18132c}
  .theme-solar{--bg:#002b36;--panel:#073642;--sidebar:#05303a;--text:#eee8d5;--muted:#93a1a1;--primary:#b58900;--accent:#2aa198;--danger:#dc322f;--warning:#cb4b16;--success:#859900;--border:#0b3942;--card:#083440}

  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;-webkit-text-size-adjust:100%}
  [data-ink]{color:var(--text)!important}
  input,textarea,select,.btn,.pill,.hint,.counter{color:var(--text)}

  .app{display:grid;grid-template-columns:280px 1fr;height:100vh;min-width:0}
  .sidebar{background:var(--sidebar);border-right:1px solid var(--border);padding:16px 12px;overflow:auto}
  .main{display:flex;flex-direction:column;background:var(--panel);min-width:0}
  .topbar{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--panel);z-index:5;flex-wrap:wrap}
  .toolbar{display:flex;gap:8px;margin-left:auto;overflow:auto;max-width:100%}
  .btn{border:1px solid var(--border);background:transparent;padding:10px 12px;border-radius:12px;cursor:pointer;transition:.15s;display:inline-flex;align-items:center;gap:6px;white-space:nowrap}
  .btn:hover{background:color-mix(in srgb,var(--primary) 12%,transparent)}
  .btn.primary{border-color:color-mix(in srgb,var(--primary) 50%,var(--border));background:color-mix(in srgb,var(--primary) 18%,transparent)}
  .btn.danger{border-color:color-mix(in srgb,var(--danger) 50%,var(--border));background:color-mix(in srgb,var(--danger) 12%,transparent)}
  .btn:disabled{opacity:.55;pointer-events:none}
  .search{flex:1;min-width:180px;max-width:520px;display:flex;align-items:center;gap:8px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:8px 10px}
  .search input{border:none;background:transparent;outline:none;width:100%}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:var(--card)}
  .folders-header{display:flex;align-items:center;justify-content:space-between;margin:10px 6px 6px}
  .folder-list{display:flex;flex-direction:column;gap:6px}
  .folder{display:flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:var(--card);cursor:pointer}
  .folder.active{outline:2px solid var(--primary)}
  .content{flex:1;overflow:auto;padding:0 12px 12px}

  .folder .folder-ico{width:20px;display:inline-flex;justify-content:center;align-items:center;opacity:.9}
  .folder .folder-name{flex:1}
  .folder{justify-content:space-between}
  .folder-actions .btn{padding:4px 6px}


  .hero{position:relative;margin:10px 0 8px;border:1px solid var(--border);border-radius:14px;padding:14px;overflow:hidden;background:
    radial-gradient(1200px 300px at -10% -80%, color-mix(in srgb,var(--primary) 25%, transparent), transparent),
    radial-gradient(900px 240px at 120% -60%, color-mix(in srgb,var(--accent) 28%, transparent), transparent),
    var(--card);}
  .hero h1{margin:0;font-size:18px}
  .hero p{margin:6px 0 0;color:var(--muted)}
  .hero svg{position:absolute;right:8px;bottom:-6px;width:150px;opacity:.25}
  @media (max-width:480px){ .hero{display:none} }

  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px}
  .list{display:flex;flex-direction:column;gap:10px}

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:14px;
  padding:12px;
  display:flex;
  flex-direction:row;    /* <â€” fila: fotos izq, contenido der */
  gap:12px;
  box-shadow:var(--shadow);
  min-width:0;
  user-select:none;
}

/* Columnas de la tarjeta */
.card .left{ flex:0 0 120px; display:flex; align-items:flex-start }
.card .right{ flex:1; min-width:0; display:flex; flex-direction:column; gap:8px }

/* Fotos en columna, con wrap si hay varias */
.card .photos{ display:flex; flex-direction:column; gap:6px; flex-wrap:wrap; max-height:220px; overflow:auto; padding-right:4px }
.card .thumb{ width:110px; height:110px }  /* mÃ¡s grande al quedar a la izquierda */

/* Colapsado: oculta contenido visual secundario */
.card.collapsed .photos,
.card.collapsed .desc,
.card.collapsed .meta,
.card.collapsed .row{ display:none }

/* Responsive: en pantallas estrechas volvemos a apilar */
@media (max-width: 560px){
  .card{ flex-direction:column }
  .card .left{ flex:0 0 auto }
  .card .photos{ flex-direction:row; max-height:none }
  .card .thumb{ width:80px; height:80px }
}

  .card.dragging{opacity:.6}
  .card.collapsed .photos,.card.collapsed .desc,.card.collapsed .meta,.card.collapsed .row{display:none}
  .card.selected{outline:2px solid color-mix(in srgb,var(--primary) 70%, transparent); box-shadow:0 0 0 3px color-mix(in srgb,var(--primary) 25%, transparent)}
  .card-header{display:flex;align-items:center;gap:8px;min-width:0}
  .title{font-weight:700;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .person{font-size:12px;color:var(--muted);border:1px solid var(--border);padding:2px 6px;border-radius:999px}
  .desc{color:var(--muted);display:-webkit-box;-webkit-line-clamp:5;-webkit-box-orient:vertical;overflow:hidden}
  .meta{display:flex;flex-wrap:wrap;gap:6px;color:var(--muted)}
  .tag{font-size:12px;border:2px dotted var(--border);padding:4px 10px;border-radius:999px;display:inline-flex;align-items:center;gap:6px;background:transparent}
  .photos{display:flex;gap:6px;flex-wrap:wrap}
  .thumb{width:80px;height:80px;border:1px solid var(--border);border-radius:8px;overflow:hidden;background:#0002;display:inline-flex;align-items:center;justify-content:center;position:relative}
  .thumb img{width:100%;height:100%;object-fit:cover}
  .thumb .x{position:absolute;top:2px;right:2px}

/* Base */
.tag{
  font-size:12px;
  border:2px dotted var(--border);
  padding:4px 10px;
  border-radius:999px;
  display:inline-flex;
  align-items:center;
  gap:6px;
  background:transparent;
}

/* Colores por tipo â€” todos distintos y consistentes */
.tag.folder{ border-color:var(--muted);   color:var(--muted) }       /* Carpeta */
.tag.dose  { border-color:var(--text);    color:var(--text) }        /* PosologÃ­a */
.tag.next  { border-color:var(--primary); color:var(--primary) }     /* PrÃ³xima toma */
.tag.urgente{border-color:var(--danger);  color:var(--danger) }      /* Urgente */
.tag.cronico{border-color:var(--warning); color:var(--warning) }     /* CrÃ³nico */
.tag.prn   { border-color:var(--success); color:var(--success) }     /* Cuando sea necesario */
.tag.prueba{ border-color:var(--accent);  color:var(--accent) }      /* En prueba */



  .table{width:100%;border-collapse:collapse;background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden}
  .table th,.table td{padding:10px;border-bottom:1px solid var(--border)}
  .table th{text-align:left;color:var(--muted);font-weight:600;background:color-mix(in srgb,var(--card) 70%,var(--panel))}
  .table tr:hover td{background:color-mix(in srgb,var(--primary) 8%, transparent)}

  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:1000}
  .modal.open{display:flex}
  .dialog{background:var(--panel);border:1px solid var(--border);border-radius:16px;min-width:320px;max-width:860px;width:100%;box-shadow:var(--shadow);max-height:92vh;display:flex;flex-direction:column}
  .dialog .hd{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border);font-weight:700}
  .dialog .bd{padding:14px;display:grid;gap:10px;overflow:auto;-webkit-overflow-scrolling:touch}
  .dialog .ft{display:flex;justify-content:flex-end;gap:8px;padding:12px 14px;border-top:1px solid var(--border)}
  .field{display:grid;gap:6px}
  .field input,.field textarea,.field select{border:1px solid var(--border);background:var(--card);padding:10px;border-radius:12px;outline:none}

  html,body{overflow-x:hidden}
  @media (max-width: 820px){ .app{grid-template-columns:1fr} .sidebar{position:fixed;left:0;top:0;bottom:0;width:88vw;max-width:320px;transform:translateX(-110%);transition:.2s;z-index:1100} .sidebar.open{transform:translateX(0)} .content{padding:10px} .search{min-width:0}}
  .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:1050}
  .backdrop.show{display:block}

  .logo{display:inline-flex;align-items:center;gap:8px;font-weight:800;letter-spacing:.2px}
  .logo svg{width:24px;height:24px}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;border:1px solid var(--border);background:var(--card);padding:2px 6px;border-radius:6px}

  .pill select{
    appearance:none;
    -webkit-appearance:none;
    background:var(--panel);
    border:none;
    outline:none;
    color:var(--text);
    font-weight:600;
    padding:6px 8px;
  }
  .pill{
    border-style:solid;
    border-width:1px;
    border-color:var(--border);
    background:var(--card);
  }

</style>
</head>
<body>
<div class="app" id="app">
  <aside class="sidebar" id="sidebar">
    <div class="folders-header" style="justify-content:flex-start;gap:8px">
      <button class="btn" id="btnCloseMenu" type="button" title="Cerrar menÃº">âŸµ</button>
      <strong data-ink>Carpetas</strong>
      <button class="btn" id="btnNewFolder" type="button" title="Nueva carpeta">ï¼‹</button>
    </div>
    <div class="folder-list" id="folderList" aria-label="Lista de carpetas"></div>
    <hr style="border-color:var(--border);margin:12px 0"/>
    <div class="folders-header">
      <strong data-ink>Papelera</strong>
      <div>
        <button class="btn" id="btnTrash" type="button">Ver</button>
        <button class="btn danger" id="btnEmptyTrash" type="button">Vaciar</button>
      </div>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <button class="btn" id="btnMenu" type="button" aria-label="Abrir menÃº">â˜°</button>

      <div class="logo" title="BotiquÃ­n">
        <svg viewBox="0 0 64 64" aria-hidden="true">
          <defs>
            <linearGradient id="g1" x1="0" x2="1">
              <stop offset="0" stop-color="var(--primary)"/>
              <stop offset="1" stop-color="var(--accent)"/>
            </linearGradient>
          </defs>
          <!-- bottle -->
          <rect x="22" y="6" width="20" height="8" rx="2" fill="url(#g1)"></rect>
          <rect x="25" y="14" width="14" height="6" rx="2" fill="url(#g1)" opacity="0.8"></rect>
          <rect x="16" y="20" width="32" height="30" rx="10" fill="none" stroke="url(#g1)" stroke-width="3"></rect>
          <circle cx="32" cy="35" r="9" fill="none" stroke="url(#g1)" stroke-width="3"></circle>
          <path d="M32 30v10M27 35h10" stroke="url(#g1)" stroke-width="3" stroke-linecap="round"/>
        </svg>
        <span data-ink>BotiquÃ­n</span>
      </div>

      <div class="pill"><select id="viewSelect">
        <option value="cards">CuadrÃ­cula</option>
        <option value="list">Tarjetas alargadas</option>
        <option value="table">Tabla</option>
      </select></div>
      <div class="pill"><select id="sortSelect">
        <option value="name">Por nombre</option>
        <option value="nextDose">Por prÃ³xima toma</option>
        <option value="person">Por persona</option>
        <option value="updated">MÃ¡s recientes</option>
      </select></div>
      <div class="search" title="Buscar por nombre, descripciÃ³n, posologÃ­a, persona o etiqueta">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--muted)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        <input id="searchInput" placeholder="Buscarâ€¦ (nombre, descripciÃ³n, posologÃ­a, persona o etiqueta)"/>
      </div>
      <div class="toolbar">
        <button class="btn" id="btnSelectMode" type="button" title="M (selecciÃ³n mÃºltiple)">Seleccionar</button>
        <button class="btn danger" id="btnDeleteSelected" type="button" disabled>Eliminar sel.</button>
        <button class="btn" id="btnUndo" type="button" title="Ctrl+Z">â†¶</button>
        <button class="btn" id="btnRedo" type="button" title="Ctrl+Y / Ctrl+Shift+Z">â†·</button>
        <button class="btn primary" id="btnNewMed" type="button" title="N">+ Medicamento</button>
        <button class="btn" id="btnImport" type="button">Importar</button>
        <button class="btn" id="btnExport" type="button">Exportar</button>
        <button class="btn" id="btnNotify" type="button" title="Notificaciones">ðŸ””</button>
        <button class="btn" id="btnTheme" type="button" title="Tema">ðŸŽ¨</button>
      </div>
    </div>

    <div class="content">
      <section class="hero" aria-label="Cabecera visual">
        <h1 data-ink>Tu botiquÃ­n, organizado</h1>
        <p data-ink>Optimizado para mÃ³vil. Doble toque en una tarjeta para plegar/desplegar. Tip: <span class="kbd">N</span> nuevo Â· <span class="kbd">/</span> buscar Â· <span class="kbd">M</span> seleccionar Â· <span class="kbd">Supr</span> borrar.</p>
        <svg viewBox="0 0 220 120" aria-hidden="true">
          <defs><linearGradient id="p1" x1="0" x2="1"><stop offset="0" stop-color="var(--primary)"/><stop offset="1" stop-color="var(--accent)"/></linearGradient></defs>
          <g opacity="0.9">
            <rect x="120" y="10" width="56" height="20" rx="4" fill="url(#p1)"/>
            <rect x="126" y="28" width="44" height="10" rx="3" fill="url(#p1)" opacity="0.8"/>
            <rect x="110" y="40" width="76" height="60" rx="14" fill="none" stroke="url(#p1)" stroke-width="4"/>
            <rect x="120" y="56" width="56" height="26" rx="8" fill="url(#p1)" opacity="0.16"/>
            <g transform="translate(18,55) rotate(-18)"><rect x="0" y="0" width="70" height="24" rx="12" fill="url(#p1)"/><rect x="0" y="0" width="35" height="24" rx="12" fill="var(--card)"/></g>
            <g transform="translate(34,78) rotate(12)"><rect x="0" y="0" width="70" height="24" rx="12" fill="url(#p1)"/><rect x="35" y="0" width="35" height="24" rx="12" fill="var(--card)"/></g>
          </g>
        </svg>
      </section>

      <div id="breadcrumb" class="hint" style="margin:0 0 10px 2px" data-ink></div>
      <div id="cardsView" class="grid" aria-live="polite"></div>
      <div id="listView" class="list" style="display:none"></div>
      <div id="tableView" style="display:none"></div>
    </div>
  </main>
</div>

<!-- Modal medicamento -->
<div class="modal" id="medModal" role="dialog" aria-modal="true">
  <div class="dialog">
    <div class="hd">Medicamento <button class="btn" id="closeMedModal" type="button">âœ•</button></div>
    <div class="bd">
      <div class="field"><label>Nombre *</label><input id="medName" placeholder="Ej. Amoxicilina 500 mg"/></div>
      <div class="field"><label>DescripciÃ³n</label><textarea id="medDesc" placeholder="SÃ­ntomas, notas (opcional)"></textarea></div>
      <div class="field"><label>Frecuencia / PosologÃ­a</label><input id="medDose" placeholder="Ej. Cada 8h durante 5 dÃ­as (opcional)"/></div>
      <div class="field"><label>Persona</label><input id="medPerson" placeholder="Ej. Laura, BebÃ© (opcional)"/></div>
      <div class="field"><label>Carpeta</label><select id="medFolder"></select></div>
      <div class="field"><label>Etiquetas</label>
        <div class="pill"><input type="checkbox" id="tagUrgente"> Urgente</div>
        <div class="pill"><input type="checkbox" id="tagCronico"> CrÃ³nico</div>
        <div class="pill"><input type="checkbox" id="tagPrueba"> En prueba</div>
        <div class="pill"><input type="checkbox" id="tagPRN"> Cuando sea necesario</div>
      </div>
      <div class="field"><label>PrÃ³xima toma</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input type="datetime-local" id="medNext"/><span class="hint">(opcional)</span>
        </div>
      </div>
      <div class="field"><label>Fotos</label>
        <input type="file" id="medPhotos" accept="image/*" multiple/>
        <div class="photos" id="medPhotosPreview" style="margin-top:6px"></div>
        <div class="hint">Arrastra imÃ¡genes aquÃ­ o sobre una tarjeta. Se reducen a 1200px.</div>
      </div>
    </div>
    <div class="ft">
      <button class="btn danger" id="btnArchive" type="button">Finalizar y archivar</button>
      <button class="btn" id="btnCancelEdit" type="button">Cancelar</button>
      <button class="btn primary" id="btnSaveMed" type="button" title="Ctrl+Enter">Guardar</button>
    </div>
  </div>
</div>

<!-- Modal carpeta -->
<div class="modal" id="folderModal" role="dialog" aria-modal="true">
  <div class="dialog">
    <div class="hd">Carpeta <button class="btn" id="closeFolderModal" type="button">âœ•</button></div>
    <div class="bd"><div class="field"><label>Nombre</label><input id="folderName" placeholder="Ej. AntibiÃ³ticos"/></div></div>
    <div class="ft"><button class="btn" id="btnCancelFolder" type="button">Cancelar</button><button class="btn primary" id="btnSaveFolder" type="button">Guardar</button></div>
  </div>
</div>

<!-- Modal papelera -->
<div class="modal" id="trashModal" role="dialog" aria-modal="true">
  <div class="dialog">
    <div class="hd">Papelera <button class="btn" id="closeTrashModal" type="button">âœ•</button></div>
    <div class="bd" id="trashBody"></div>
    <div class="ft"><button class="btn danger" id="btnPurgeAll" type="button">Eliminar definitivamente</button><button class="btn" id="btnCloseTrash" type="button">Cerrar</button></div>
  </div>
</div>

<input type="file" id="fileInput" accept="application/json" style="display:none"/>
<div id="backdrop" class="backdrop"></div>

<script>
// ====== Utilidades base ======
const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
const uid=(p='id')=>p+'_'+Math.random().toString(36).slice(2,9);
const confirmBox=msg=>window.confirm(msg);

// ====== Estado ======
const STORAGE_KEY='botiquin.v6'; // nueva versiÃ³n unificada
let state={
  folders:[
    {id:'all',name:'Todos',order:0},
    {id:'arch',name:'Archivados',order:1},
    {id:'antib',name:'AntibiÃ³ticos',order:2},
    {id:'analg',name:'AnalgÃ©sicos',order:3},
    {id:'vitam',name:'Vitaminas',order:4},
    {id:'antihist',name:'AntihistamÃ­nicos',order:5},
    {id:'pomadas',name:'Pomadas y cremas',order:6},
    {id:'ocular',name:'Salud ocular',order:7},
    {id:'mental',name:'Salud mental',order:8}
  ],
  meds:[],
  trash:{meds:[],folders:[]},
  view:'cards', sort:'name', theme:'dark', activeFolder:'all',
  selectMode:false, selected:new Set(), collapsed:{},
};
const history={undo:[],redo:[],push(){this.undo.push(JSON.stringify({...state,selected:[...state.selected]})); if(this.undo.length>50)this.undo.shift(); this.redo.length=0;},
  canUndo(){return this.undo.length>0}, canRedo(){return this.redo.length>0},
  doUndo(){if(!this.canUndo())return; this.redo.push(JSON.stringify({...state,selected:[...state.selected]})); state=JSON.parse(this.undo.pop()); state.selected=new Set(state.selected||[]); renderAll(); save();},
  doRedo(){if(!this.canRedo())return; this.undo.push(JSON.stringify({...state,selected:[...state.selected]})); state=JSON.parse(this.redo.pop()); state.selected=new Set(state.selected||[]); renderAll(); save();}
};

function load(){
  const raw=localStorage.getItem(STORAGE_KEY);
  if(raw){ try{ state=JSON.parse(raw); state.selected=new Set(state.selected||[]);}catch{} }
  applyTheme(state.theme||'dark');
}
function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify({...state,selected:[...state.selected]})); }

const THEMES=['dark','light','olive','aqua','amethyst','solar'];
function applyTheme(name){
  document.body.classList.remove(...THEMES.map(t=>'theme-'+t));
  if(name!=='dark') document.body.classList.add('theme-'+name);
  state.theme=name||'dark';
  // Auto-contraste para elementos data-ink (mejora de legibilidad)
  requestAnimationFrame(()=>{
    $$('[data-ink]').forEach(el=>{ el.style.color=getComputedStyle(document.body).getPropertyValue('--text') });
  });
}

// ====== Persistencia inicial ======
load();

// ====== PWA (manifest + SW en memoria) ======
(function setupPWA(){
  try{
    const manifest = {
      "name":"BotiquÃ­n Â· Gestor de Medicamentos",
      "short_name":"BotiquÃ­n",
      "start_url":"./",
      "display":"standalone",
      "background_color":"#151925",
      "theme_color":"#151925",
      "icons":[
        {"src":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAQAAAB4pVU2AAAAH0lEQVR42u3BAQ0AAADCoPdPbQ8HFAAAAAAAAAAAAACwFQd0AAGv1S5cAAAAAElFTkSuQmCC","sizes":"128x128","type":"image/png"}
      ]
    };
    const m = new Blob([JSON.stringify(manifest)],{type:'application/manifest+json'});
    const url = URL.createObjectURL(m);
    const link = document.getElementById('inline-manifest');
    link.setAttribute('href', url);

    if('serviceWorker' in navigator){
      const swCode = `self.addEventListener('install',e=>{e.waitUntil(caches.open('botiquin-cache-v1').then(c=>c.addAll(['./'])))});
        self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).then(res=>{return res})).catch(()=>caches.match('./')))});`;
      const swBlob = new Blob([swCode],{type:'text/javascript'});
      const swUrl = URL.createObjectURL(swBlob);
      navigator.serviceWorker.register(swUrl);
    }
  }catch(e){ console.warn('PWA setup skipped', e); }
})();

// ====== Acceso a elementos ======
const els={
  folderList:$('#folderList'), sidebar:$('#sidebar'), backdrop:$('#backdrop'),
  viewSelect:$('#viewSelect'), sortSelect:$('#sortSelect'), searchInput:$('#searchInput'),
  cardsView:$('#cardsView'), listView:$('#listView'), tableView:$('#tableView'),
  breadcrumb:$('#breadcrumb'),
  btnNewMed:$('#btnNewMed'), btnImport:$('#btnImport'), btnExport:$('#btnExport'),
  btnUndo:$('#btnUndo'), btnRedo:$('#btnRedo'), btnTheme:$('#btnTheme'),
  btnNotify:$('#btnNotify'), btnSelectMode:$('#btnSelectMode'), btnDeleteSelected:$('#btnDeleteSelected'),
  btnMenu:$('#btnMenu'), btnCloseMenu:$('#btnCloseMenu'),
  btnTrash:$('#btnTrash'), btnEmptyTrash:$('#btnEmptyTrash')
};


function folderIcon(name){
  name=(name||'').toLowerCase();
  if(name==='todos') return 'âšª';            // cÃ­rculo para "Todos"
  if(name.includes('antib')) return 'ðŸ’Š';
  if(name.includes('analg')) return 'ðŸ’‰';
  if(name.includes('vitam')) return 'ðŸŠ';
  if(name.includes('antihist')) return 'ðŸ¤§';
  if(name.includes('pomad')||name.includes('crema')) return 'ðŸ§´';
  if(name.includes('ocular')||name.includes('ojo')) return 'ðŸ‘ï¸';
  if(name.includes('mental')||name.includes('Ã¡nimo')) return 'ðŸ§ ';
  return 'ðŸ“‚';
}


// ====== Render ======
function renderAll(){
  renderFolders();
  renderBreadcrumb();
  renderMainView();
  updateToolbar();
}

function currentMeds(){
  const q=(els.searchInput.value||'').trim().toLowerCase();
  let meds = state.meds.filter(m=>!m.deleted);
  // Filtro por carpeta/archivo
  if(state.activeFolder==='arch') meds = meds.filter(m=>m.archived);
  else if(state.activeFolder!=='all') meds = meds.filter(m=>m.folderId===state.activeFolder && !m.archived);
  else meds = meds.filter(m=>!m.archived);

  // BÃºsqueda (nombre, desc, posologÃ­a, persona, etiquetas, carpeta)
  if(q){
    meds = meds.filter(m=>{
      const folderName = (state.folders.find(f=>f.id===m.folderId)||{}).name||'';
      const tags = [m.tags?.urgente?'urgente':'', m.tags?.cronico?'cronico':'', m.tags?.prueba?'prueba':'', m.tags?.prn?'prn':''].join(' ');
      return [m.name,m.desc,m.dose,m.person,folderName,tags].join(' ').toLowerCase().includes(q);
    });
  }

  // OrdenaciÃ³n
  const byName=(a,b)=>a.name.localeCompare(b.name, 'es', {sensitivity:'base'});
  const byNext=(a,b)=> (a.next||'').localeCompare(b.next||'');
  const byPerson=(a,b)=> (a.person||'').localeCompare(b.person||'', 'es', {sensitivity:'base'});
  const byUpdated=(a,b)=> (b.updated||0)-(a.updated||0);
  const sorters={name:byName,nextDose:byNext,person:byPerson,updated:byUpdated};
  meds.sort(sorters[state.sort]||byName);
  return meds;
}

function renderFolders(){
  const list = state.folders.filter(f=>!f.deleted).sort((a,b)=>a.order-b.order);
  els.folderList.innerHTML='';
  list.forEach(f=>{
    const li=document.createElement('div');
    li.className='folder'+(state.activeFolder===f.id?' active':'');
    li.draggable = f.id!=='all' && f.id!=='arch';
    li.innerHTML=`<span class="folder-ico">${folderIcon(f.name)}</span><span class="folder-name">${f.name}</span>
      <span class="folder-actions">
        ${f.id!=='all' && f.id!=='arch'? '<button class="btn btn-rename" title="Renombrar">âœŽ</button><button class="btn btn-del" title="Eliminar">ðŸ—‘</button>': ''}
      </span>`;
    li.addEventListener('click', (e)=>{
      if(e.target.closest('.btn')) return;
      state.activeFolder=f.id; renderAll(); save();
      if(innerWidth<820) closeSidebar();
    });
    // DnD de medicamentos sobre carpeta
    li.addEventListener('dragover',e=>{e.preventDefault(); li.style.outline='2px dashed var(--primary)'});
    li.addEventListener('dragleave',()=>{li.style.outline=''});
    li.addEventListener('drop',e=>{
      e.preventDefault(); li.style.outline='';
      const ids=(e.dataTransfer.getData('text/plain')||'').split(',').filter(Boolean);
      if(!ids.length) return;
      history.push();
      ids.forEach(id=>{ const m=state.meds.find(x=>x.id===id); if(m){ m.folderId=f.id; m.updated=Date.now(); } });
      renderAll(); save();
    });
    // Renombrar/Eliminar
    li.querySelector('.btn-rename')?.addEventListener('click',()=>openFolderModal(f));
    li.querySelector('.btn-del')?.addEventListener('click',()=>deleteFolder(f.id));
    els.folderList.appendChild(li);
  });
}

function renderBreadcrumb(){
  const f = state.folders.find(x=>x.id===state.activeFolder);
  els.breadcrumb.textContent = f ? `Carpeta: ${f.name}` : '';
}

function renderMainView(){
  const meds=currentMeds();
  // Vistas
  $('#cardsView').style.display = state.view==='cards'?'grid':'none';
  $('#listView').style.display = state.view==='list'?'flex':'none';
  $('#tableView').style.display = state.view==='table'?'block':'none';

  if(state.view==='cards' || state.view==='list'){ renderCards(meds, state.view==='list'); }
  else renderTable(meds);
}

function cardHTML(m){
  const folderName = (state.folders.find(f=>f.id===m.folderId)||{}).name||'â€”';
  const nextTag = m.next ? `<span class="tag next" title="PrÃ³xima toma">${new Date(m.next).toLocaleString()}</span>` : '';
const tags = [
    m.tags?.urgente?'<span class="tag urgente">Urgente</span>':'',
    m.tags?.cronico?'<span class="tag cronico">CrÃ³nico</span>':'',
    m.tags?.prueba?'<span class="tag prueba">En prueba</span>':'',
    m.tags?.prn?'<span class="tag prn">Cuando sea necesario</span>':''
  ].filter(Boolean).join(' ');
  const photos = (m.photos||[]).map((src,i)=>`<div class="thumb" data-i="${i}"><img src="${src}" alt="Foto"/><button class="btn x" title="Quitar foto">Ã—</button></div>`).join('');
  const collapsed = state.collapsed[m.id];
return `<div class="card ${collapsed?'collapsed':''}" data-id="${m.id}" draggable="true">
  <div class="left">
    <div class="photos">${photos}</div>
  </div>
  <div class="right">
    <div class="card-header" title="Doble clic: plegar/desplegar">
      ${state.selectMode?'<label class="checkbox"><input type="checkbox" data-select id="sel_'+m.id+'"></label>':''}
      <div class="title">${m.name||'(Sin nombre)'}</div>
      ${m.person?`<span class="person">${m.person}</span>`:''}
    </div>
    <div class="meta">
      <span class="tag folder" title="Carpeta">${folderIcon(folderName)} ${folderName}</span>
      ${m.dose?`<span class="tag dose" title="PosologÃ­a">${m.dose}</span>`:''}
      ${nextTag}
      ${tags}
    </div>
    <div class="desc">${m.desc||''}</div>
    <div class="row">
      <button class="btn btn-edit">Editar</button>
      <button class="btn danger btn-del">Eliminar</button>
    </div>
  </div>
</div>`;

}

function renderCards(meds, isList=false){
  const cont = isList? els.listView : els.cardsView;
  cont.innerHTML = meds.map(cardHTML).join('');
  // Eventos por tarjeta
  cont.querySelectorAll('.card').forEach(card=>{
    const id=card.getAttribute('data-id');
    // DnD
    card.addEventListener('dragstart', e=>{
      const ids = state.selectMode && state.selected.size? [...state.selected] : [id];
      e.dataTransfer.setData('text/plain', ids.join(','));
      card.classList.add('dragging');
    });
    card.addEventListener('dragend',()=>card.classList.remove('dragging'));
    // Dblclick collapse
    card.querySelector('.card-header').addEventListener('dblclick',()=>{ state.collapsed[id]=!state.collapsed[id]; save(); renderMainView(); });
    // Select checkbox
    card.querySelector('[data-select]')?.addEventListener('change',e=>{
      e.target.checked? state.selected.add(id) : state.selected.delete(id);
      updateToolbar();
    });
    // Botones
    card.querySelector('.btn-edit').addEventListener('click',()=>openMedModal(id));
    card.querySelector('.btn-del').addEventListener('click',()=>deleteMeds([id]));
            // Quitar foto
    card.querySelectorAll('.thumb .x').forEach(btn=>btn.addEventListener('click',()=>{
      const i=parseInt(btn.parentElement.getAttribute('data-i'),10);
      const m=state.meds.find(x=>x.id===id); if(!m) return;
      history.push();
      (m.photos||[]).splice(i,1);
      m.updated=Date.now();
      save(); renderMainView();
    }));
  });
}

function renderTable(meds){
  const rows = meds.map(m=>{
    const folderName = (state.folders.find(f=>f.id===m.folderId)||{}).name||'â€”';
    const nextTxt = m.next ? new Date(m.next).toLocaleString() : 'â€”';
    return `<tr data-id="${m.id}">
      <td>${m.name||''}</td>
      <td>${m.person||''}</td>
      <td>${folderName}</td>
      <td>${m.dose||''}</td>
      <td>${m.desc||''}</td>
      <td>${nextTxt}</td>
      <td><button class="btn btn-edit">Editar</button> <button class="btn danger btn-del">Eliminar</button></td>
    </tr>`
  }).join('');
  els.tableView.innerHTML = `<table class="table">
    <thead><tr><th>Nombre</th><th>Persona</th><th>Carpeta</th><th>PosologÃ­a</th><th>DescripciÃ³n</th><th>PrÃ³x. toma</th><th>Acciones</th></tr></thead>
    <tbody>${rows}</tbody>
  </table>`;
  els.tableView.querySelectorAll('tr').forEach(tr=>{
    const id=tr.getAttribute('data-id');
    tr.querySelector('.btn-edit').addEventListener('click',()=>openMedModal(id));
    tr.querySelector('.btn-del').addEventListener('click',()=>deleteMeds([id]));
  });
}

function updateToolbar(){
  els.btnUndo.disabled = !history.canUndo();
  els.btnRedo.disabled = !history.canRedo();
  els.btnDeleteSelected.disabled = !(state.selectMode && state.selected.size);
}

// ====== CRUD Carpetas ======
function openFolderModal(folder){ // crear o editar
  const modal=$('#folderModal'); const input=$('#folderName');
  input.value = folder? folder.name : '';
  modal.classList.add('open'); showBackdrop(true);
  $('#btnSaveFolder').onclick=()=>{
    const name=input.value.trim(); if(!name) return;
    history.push();
    if(folder){ folder.name=name; folder.updated=Date.now(); }
    else{
      const id=uid('f'); state.folders.push({id,name,order:(state.folders.length+1)});
    }
    modal.classList.remove('open'); showBackdrop(false); renderFolders(); save();
  };
  $('#btnCancelFolder').onclick=()=>{ modal.classList.remove('open'); showBackdrop(false); };
  $('#closeFolderModal').onclick=()=>{ modal.classList.remove('open'); showBackdrop(false); };
}
function deleteFolder(id){
  if(!confirmBox('Â¿Eliminar carpeta? (los medicamentos pasarÃ¡n a "Todos")')) return;
  history.push();
  const f=state.folders.find(x=>x.id===id); if(!f) return;
  f.deleted=true;
  state.meds.forEach(m=>{ if(m.folderId===id) m.folderId='all'; });
  renderAll(); save();
}

// ====== CRUD Medicamentos ======
let editingId=null;
function openMedModal(id){
  const isNew = !id;
  const modal=$('#medModal');
  const fields={
    name:$('#medName'), desc:$('#medDesc'), dose:$('#medDose'),
    person:$('#medPerson'), folder:$('#medFolder'), next:$('#medNext'),
    photos:$('#medPhotos'), photosPreview:$('#medPhotosPreview'),
    tUrg:$('#tagUrgente'), tCro:$('#tagCronico'), tPrb:$('#tagPrueba'), tPrn:$('#tagPRN')
  };
  // Preparar select carpeta
  fields.folder.innerHTML = state.folders.filter(f=>!f.deleted).map(f=>`<option value="${f.id}">${f.name}</option>`).join('');

  let med = isNew? {id:uid('m'), name:'', desc:'', dose:'', person:'', folderId:state.activeFolder==='arch'?'all':state.activeFolder, next:'', tags:{}, photos:[]} : state.meds.find(x=>x.id===id);
  if(!med) return;
  editingId = med.id;

  // Rellenar
  fields.name.value = med.name||'';
  fields.desc.value = med.desc||'';
  fields.dose.value = med.dose||'';
  fields.person.value = med.person||'';
  fields.folder.value = med.folderId||'all';
  fields.next.value = med.next? new Date(med.next).toISOString().slice(0,16) : '';
  fields.tUrg.checked = !!med.tags?.urgente;
  fields.tCro.checked = !!med.tags?.cronico;
  fields.tPrb.checked = !!med.tags?.prueba;
  fields.tPrn.checked = !!med.tags?.prn;
  renderPhotosPreview(fields.photosPreview, med.photos||[]);

  // Eventos
  fields.photos.onchange = async (e)=>{
    const files=Array.from(e.target.files||[]);
    if(!files.length) return;
    const reduced = await Promise.all(files.map(resizeImageToDataURL));
    med.photos = [...(med.photos||[]), ...reduced];
    renderPhotosPreview(fields.photosPreview, med.photos);
  };

  $('#btnSaveMed').onclick = ()=>{
    if(!(fields.name.value||'').trim()){ alert('El nombre es obligatorio'); return; }
    history.push();
    med.name=fields.name.value.trim();
    med.desc=fields.desc.value.trim();
    med.dose=fields.dose.value.trim();
    med.person=fields.person.value.trim();
    med.folderId=fields.folder.value;
    med.next=fields.next.value? new Date(fields.next.value).toISOString() : '';
    med.tags={urgente:fields.tUrg.checked, cronico:fields.tCro.checked, prueba:fields.tPrb.checked, prn:fields.tPrn.checked};
    med.updated=Date.now();
    if(isNew) state.meds.push(med);
    modal.classList.remove('open'); showBackdrop(false);
    save(); renderAll();
  };
  $('#btnArchive').onclick = ()=>{
    if(!(fields.name.value||'').trim()){ alert('Pon un nombre antes de archivar.'); return; }
    history.push();
    med.name=fields.name.value.trim();
    med.desc=fields.desc.value.trim();
    med.dose=fields.dose.value.trim();
    med.person=fields.person.value.trim();
    med.folderId='arch';
    med.archived=true;
    med.updated=Date.now();
    if(isNew) state.meds.push(med);
    modal.classList.remove('open'); showBackdrop(false);
    save(); renderAll();
  };
  $('#btnCancelEdit').onclick = ()=>{ modal.classList.remove('open'); showBackdrop(false); };
  $('#closeMedModal').onclick = ()=>{ modal.classList.remove('open'); showBackdrop(false); };

  modal.classList.add('open'); showBackdrop(true);
  setTimeout(()=>fields.name.focus(),0);
}
function renderPhotosPreview(container, photos){
  container.innerHTML = (photos||[]).map((src,i)=>`<div class="thumb" data-i="${i}"><img src="${src}" alt="Foto"/><button class="btn x" title="Quitar foto">Ã—</button></div>`).join('');
  container.querySelectorAll('.thumb .x').forEach(btn=>btn.addEventListener('click',()=>{
    const i=parseInt(btn.parentElement.getAttribute('data-i'),10);
    const m=state.meds.find(x=>x.id===editingId); if(!m) return;
    history.push(); (m.photos||[]).splice(i,1); m.updated=Date.now(); renderPhotosPreview(container,m.photos); save();
  }));
}
async function resizeImageToDataURL(file, maxDim=1200){
  const img = await new Promise(res=>{ const i=new Image(); i.onload=()=>res(i); i.src=URL.createObjectURL(file); });
  const canvas=document.createElement('canvas'); const ctx=canvas.getContext('2d');
  let {width:w,height:h}=img;
  if(w>h){ if(w>maxDim){ h = Math.round(h*maxDim/w); w=maxDim; } }
  else { if(h>maxDim){ w = Math.round(w*maxDim/h); h=maxDim; } }
  canvas.width=w; canvas.height=h; ctx.drawImage(img,0,0,w,h);
  return canvas.toDataURL('image/jpeg',0.85);
}

function deleteMeds(ids){
  if(!ids?.length) return;
  if(!confirmBox(`Â¿Enviar a la papelera ${ids.length} medicamento(s)?`)) return;
  history.push();
  ids.forEach(id=>{
    const i=state.meds.findIndex(m=>m.id===id);
    if(i>=0){ const [m]=state.meds.splice(i,1); state.trash.meds.push({...m,deletedAt:Date.now()}); }
  });
  state.selected.clear(); renderAll(); save();
}


// ====== Papelera ======
function openTrash(){
  const modal=$('#trashModal'); const body=$('#trashBody');
  body.innerHTML = state.trash.meds.length? state.trash.meds.map(m=>`<div class="card"><div class="title">${m.name}</div>
    <div class="row"><button class="btn btn-restore" data-id="${m.id}">Restaurar</button>
    <button class="btn danger btn-drop" data-id="${m.id}">Eliminar</button></div></div>`).join('') : '<div class="hint">VacÃ­a</div>';
  body.querySelectorAll('.btn-restore').forEach(b=>b.addEventListener('click',()=>{
    const id=b.getAttribute('data-id'); const i=state.trash.meds.findIndex(x=>x.id===id);
    if(i>=0){ const [m]=state.trash.meds.splice(i,1); m.deleted=false; state.meds.push(m); save(); openTrash(); renderAll(); }
  }));
  body.querySelectorAll('.btn-drop').forEach(b=>b.addEventListener('click',()=>{
    const id=b.getAttribute('data-id'); const i=state.trash.meds.findIndex(x=>x.id===id);
    if(i>=0){ state.trash.meds.splice(i,1); save(); openTrash(); }
  }));
  $('#btnPurgeAll').onclick=()=>{ if(confirmBox('Â¿Eliminar todo definitivamente?')){ state.trash.meds=[]; save(); openTrash(); } };
  $('#btnCloseTrash').onclick=()=>{ modal.classList.remove('open'); showBackdrop(false); };
  $('#closeTrashModal').onclick=()=>{ modal.classList.remove('open'); showBackdrop(false); };
  modal.classList.add('open'); showBackdrop(true);
}

// ====== Import / Export ======
$('#btnExport').addEventListener('click',()=>{
  const data = JSON.stringify({...state,selected:[]}, null, 2);
  const blob = new Blob([data],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='botiquin.json'; a.click();
});
$('#btnImport').addEventListener('click',()=>$('#fileInput').click());
$('#fileInput').addEventListener('change',e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload=()=>{
    try{
      const imported=JSON.parse(reader.result);
      if(!imported.meds||!imported.folders) throw new Error('Formato no reconocido');
      history.push();
      state = {...state, ...imported};
      state.selected=new Set();
      applyTheme(state.theme||'dark');
      renderAll(); save();
      alert('Importado.');
    }catch(err){ alert('Error al importar: '+err.message); }
  };
  reader.readAsText(f);
});

// ====== Notificaciones ======
els.btnNotify.addEventListener('click', async ()=>{
  try{
    const perm = await Notification.requestPermission();
    if(perm!=='granted'){ alert('Permiso denegado.'); return; }
    scheduleNotifications();
    new Notification('Recordatorios activados', {body:'Te avisarÃ© en la hora de cada prÃ³xima toma.'});
  }catch(e){ alert('No se pudo activar notificaciones.'); }
});
function scheduleNotifications(){
  (state.meds||[]).forEach(m=>{
    if(!m.next) return;
    const t = new Date(m.next).getTime() - Date.now();
    if(t>0 && t< 1000*60*60*24*14){ // mÃ¡x 14 dÃ­as
      setTimeout(()=>{ new Notification('Toma de '+(m.name||'medicamento'), {body:(m.dose||'')||'Recuerda tomarlo.'}); }, t);
    }
  });
}

// ====== Sidebar ======
function openSidebar(){ els.sidebar.classList.add('open'); els.backdrop.classList.add('show'); }
function closeSidebar(){ els.sidebar.classList.remove('open'); els.backdrop.classList.remove('show'); }
els.btnMenu.addEventListener('click',openSidebar);
els.btnCloseMenu.addEventListener('click',closeSidebar);
els.backdrop.addEventListener('click',closeSidebar);

// ====== View / Sort ======
els.viewSelect.value = state.view;
els.sortSelect.value = state.sort;
els.viewSelect.addEventListener('change',()=>{ state.view=els.viewSelect.value; renderMainView(); save(); });
els.sortSelect.addEventListener('change',()=>{ state.sort=els.sortSelect.value; renderMainView(); save(); });

// ====== Buscar ======
els.searchInput.addEventListener('input',()=>renderMainView());

// ====== SelecciÃ³n mÃºltiple ======
els.btnSelectMode.addEventListener('click',()=>{
  state.selectMode=!state.selectMode; if(!state.selectMode) state.selected.clear();
  document.body.classList.toggle('select-mode', state.selectMode);
  updateToolbar(); renderMainView();
});
els.btnDeleteSelected.addEventListener('click',()=>deleteMeds([...state.selected]));

// ====== Top buttons ======
els.btnUndo.addEventListener('click',()=>history.doUndo());
els.btnRedo.addEventListener('click',()=>history.doRedo());
els.btnTheme.addEventListener('click',()=>{
  const i=(THEMES.indexOf(state.theme)+1)%THEMES.length;
  applyTheme(THEMES[i]); save();
});
els.btnNewMed.addEventListener('click',()=>openMedModal(null));
els.btnTrash.addEventListener('click',openTrash);
els.btnEmptyTrash.addEventListener('click',()=>{ if(confirmBox('Â¿Vaciar papelera?')){ state.trash.meds=[]; save(); }});

// ====== Atajos teclado ======
document.addEventListener('keydown',e=>{
  if(e.key==='/'){ e.preventDefault(); els.searchInput.focus(); return; }
  if(e.key==='n' || (e.key==='N')){ openMedModal(null); return; }
  if((e.ctrlKey||e.metaKey)&& e.key.toLowerCase()==='z'){ e.preventDefault(); history.doUndo(); return; }
  if((e.ctrlKey||e.metaKey)&& (e.key.toLowerCase()==='y' || (e.shiftKey && e.key.toLowerCase()==='z'))){ e.preventDefault(); history.doRedo(); return; }
  if(e.key==='Delete' && state.selectMode && state.selected.size){ deleteMeds([...state.selected]); }
  if(e.key.toLowerCase()==='m'){ state.selectMode=!state.selectMode; document.body.classList.toggle('select-mode', state.selectMode); updateToolbar(); renderMainView(); }
});

// ====== Inicializar datos si vacÃ­o ======
if(!state.meds.length && !localStorage.getItem(STORAGE_KEY)){
  state.meds.push({id:uid('m'),name:'Paracetamol 1g',desc:'Dolor leve/moderado, fiebre',dose:'Cada 8h si dolor',person:'Laura',folderId:'all',next:'',tags:{prn:true},photos:[],updated:Date.now()});
  state.meds.push({id:uid('m'),name:'Ibuprofeno 400mg',desc:'InflamaciÃ³n y dolor',dose:'Cada 8h con comida',person:'BebÃ©',folderId:'all',next:'',tags:{},photos:[],updated:Date.now()});
  save();
}

// ====== Arranque ======
renderAll();
scheduleNotifications();
</script>
</body>
</html>
